<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>GPX ë§ˆì»¤ ë° ê²½ë¡œ ì§€ë„ (v10)</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94bf4516825c146467eb2318cd55b782&libraries=services"></script>
<style>
  html, body { height:100%; margin:0; padding:0; overflow:hidden; }
  #map { width:100%; height:100%; position:absolute; top:0; left:0; }
  #search-form { position:absolute; top:10px; left:10px; z-index:1000; background:white; padding:5px; border-radius:5px; box-shadow:0 2px 6px rgba(0,0,0,0.3); display:flex; gap:5px; }
  .controls { position:absolute; top:10px; right:10px; z-index:1000; background:white; padding:5px; border-radius:5px; box-shadow:0 2px 6px rgba(0,0,0,0.3); display:flex; gap:6px; align-items:center; }
  #myLocationBtn { position:absolute; bottom:20px; right:20px; z-index:10000; background:white; padding:8px; border-radius:50%; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
</style>
</head>
<body>
<form id="search-form">
  <input id="address-input" type="text" placeholder="ì£¼ì†Œ ê²€ìƒ‰" style="padding:5px; width:180px;"/>
  <button type="submit" style="padding:5px;">ê²€ìƒ‰</button>
  <input id="address-display" type="text" placeholder="ì£¼ì†Œ" readonly style="padding:5px; width:200px;"/>
</form>
<div id="myLocationBtn" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ“</div>
<div class="controls">
  <label>ìœ„ë„:</label><input id="latitude" readonly size="12"/>
  <label>ê²½ë„:</label><input id="longitude" readonly size="12"/>
  <button onclick="copyCoordinates()">ë³µì‚¬ (Ctrl+C)</button>
  <button onclick="startDrawing()">ì„  ê·¸ë¦¬ê¸° (Ctrl+L)</button>
  <button onclick="resetPolylines()">ì„  ì´ˆê¸°í™”</button>
  <button onclick="exportGPX()">GPX ë‚´ë³´ë‚´ê¸°</button>
</div>
<div id="map"></div>
<script>
let map, drawingMode=false, isFirstDraw=true;
let markers=[], polylines=[];
let selectedLatLng=null, currentPolyline=null, currentPath=[];
let geocoder; // reverse geocoder instance

// ë§µ ì´ˆê¸°í™” (í•­ê³µì˜ìƒ)
function initializeMap(center){
  map = new kakao.maps.Map(document.getElementById('map'), {
    center: center,
    level: 4,
    mapTypeId: kakao.maps.MapTypeId.SKYVIEW
  });
  geocoder = new kakao.maps.services.Geocoder();
  map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
  map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

  kakao.maps.event.addListener(map, 'click', e => {
    selectedLatLng = e.latLng;
    document.getElementById('latitude').value = selectedLatLng.getLat();
    document.getElementById('longitude').value = selectedLatLng.getLng();
    // ì£¼ì†Œ ì—­ì§€ì˜¤ì½”ë”©
    geocoder.coord2Address(
      selectedLatLng.getLng(), selectedLatLng.getLat(),
      (result, status) => {
        if(status === kakao.maps.services.Status.OK) {
          document.getElementById('address-display').value = result[0].address.address_name;
        } else {
          document.getElementById('address-display').value = '';
        }
      }
    );
    if(drawingMode){
      currentPath.push(selectedLatLng);
      currentPolyline.setPath(currentPath);
    }
  });

  kakao.maps.event.addListener(map, 'rightclick', e => {
    if(drawingMode){
      drawingMode=false;
    } else {
      addMarker(e.latLng);
    }
  });
}

// ë‚´ ìœ„ì¹˜ ì´ë™
function moveToMyLocation(){
  if(!navigator.geolocation){
    return alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      const ll = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      map.setCenter(ll);
      document.getElementById('latitude').value = pos.coords.latitude;
      document.getElementById('longitude').value = pos.coords.longitude;
      // ì£¼ì†Œ ì—…ë°ì´íŠ¸ (ì˜µì…˜)
      geocoder.coord2Address(pos.coords.longitude, pos.coords.latitude, (r, s) => {
        if(s === kakao.maps.services.Status.OK) document.getElementById('address-display').value = r[0].address.address_name;
      });
    },
    err => alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message)
  );
}

// ë§ˆì»¤ ìƒì„±
function addMarker(latlng, presetDesc){
  if(!latlng) return alert('ì¢Œí‘œë¥¼ ë¨¼ì € í´ë¦­í•´ì£¼ì„¸ìš”');
  let desc = (typeof presetDesc === 'string') ? presetDesc : prompt('ë§ˆì»¤ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'ì„¤ëª… ì—†ìŒ');
  if(desc === null) return;
  if(desc.trim() === '') desc = 'ì„¤ëª… ì—†ìŒ';
  const marker = new kakao.maps.Marker({ map, position: latlng });
  const info = document.createElement('div');
  info.style = 'position:relative;padding:5px 25px 5px 5px;font-size:13px';
  info.innerHTML = desc;
  const closeBtn = document.createElement('div');
  closeBtn.innerHTML = 'âœ–'; closeBtn.style = 'position:absolute;top:5px;right:0;cursor:pointer;font-weight:\
bold';
  info.appendChild(closeBtn);
  const iw = new kakao.maps.InfoWindow({ content: info });
  kakao.maps.event.addListener(marker, 'click', () => iw.open(map, marker));
  closeBtn.onclick = () => iw.close();
  kakao.maps.event.addListener(marker, 'rightclick', () => {
    if(confirm('ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
      marker.setMap(null);
      markers = markers.filter(m => m.marker !== marker);
    }
  });
  markers.push({ marker, infowindow: iw, desc });
}

// í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸°
function startDrawing(){
  if(drawingMode){ drawingMode=false; return; }
  drawingMode=true; currentPath=[];
  currentPolyline = new kakao.maps.Polyline({ map, path: currentPath, strokeWeight:3, strokeColor:'#FF0000', strokeOpacity:0.8, strokeStyle:'solid' });
  kakao.maps.event.addListener(currentPolyline, 'rightclick', () => {
    if(confirm('ì´ ê²½ë¡œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
      currentPolyline.setMap(null);
      polylines = polylines.filter(p => p !== currentPolyline);
    }
  });
  kakao.maps.event.addListener(currentPolyline, 'mouseover', () => map.getContainer().style.cursor='pointer');
  kakao.maps.event.addListener(currentPolyline, 'mouseout', () => map.getContainer().style.cursor='default');
  polylines.push(currentPolyline);
}

// GPX ë“œë¡­ ë¡œë“œ ë° ê¸°íƒ€ ê¸°ëŠ¥ (ì´ì „ ë²„ì „ê³¼ ë™ì¼)
// ... ì´í•˜ ê¸°ì¡´ GPX import, resetPolylines, exportGPX, copyCoordinates, ì´ë²¤íŠ¸ ë°”ì¸ë”© ë“± ìœ ì§€ ...

// GPX íŒŒì¼ ë“œë¡­ ë¡œë“œ
// (ì›ë³¸ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ì‹œë©´ ë©ë‹ˆë‹¤)

document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('myLocationBtn').addEventListener('click', moveToMyLocation);
  document.getElementById('search-form').addEventListener('submit', e=>{
    e.preventDefault();
    new kakao.maps.services.Geocoder().addressSearch(
      document.getElementById('address-input').value,
      (r,s)=> s===kakao.maps.services.Status.OK? map.setCenter(new kakao.maps.LatLng(r[0].y,r[0].x)) : alert('ê²€ìƒ‰ ì‹¤íŒ¨')
    );
  });
});

window.onload = () => {
  if(navigator.geolocation) navigator.geolocation.getCurrentPosition(
    pos => initializeMap(new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude)),
    () => initializeMap(new kakao.maps.LatLng(37.5665,126.9780))
  );
  else initializeMap(new kakao.maps.LatLng(37.5665,126.9780));
};
</script>
</body>
</html>
