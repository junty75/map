<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>GPX 마커 및 경로 지도 (v10)</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94bf4516825c146467eb2318cd55b782&libraries=services"></script>
<style>
  html, body { height:100%; margin:0; padding:0; overflow:hidden; }
  #map { width:100%; height:100%; position:absolute; top:0; left:0; }
  #search-form { position:absolute; top:10px; left:10px; z-index:1000; background:white; padding:5px; border-radius:5px; box-shadow:0 2px 6px rgba(0,0,0,0.3); display:flex; gap:5px; }
  .controls { position:absolute; top:10px; right:10px; z-index:1000; background:white; padding:5px; border-radius:5px; box-shadow:0 2px 6px rgba(0,0,0,0.3); display:flex; gap:6px; align-items:center; }
  #myLocationBtn { position:absolute; bottom:20px; right:20px; z-index:10000; background:white; padding:8px; border-radius:50%; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
</style>
</head>
<body>
<form id="search-form">
  <input id="address-input" type="text" placeholder="주소 검색" style="padding:5px; width:180px;"/>
  <button type="submit" style="padding:5px;">검색</button>
  <input id="address-display" type="text" placeholder="주소" readonly style="padding:5px; width:200px;"/>
</form>
<div id="myLocationBtn" title="내 위치로 이동">📍</div>
<div class="controls">
  <label>위도:</label><input id="latitude" readonly size="12"/>
  <label>경도:</label><input id="longitude" readonly size="12"/>
  <button onclick="copyCoordinates()">복사 (Ctrl+C)</button>
  <button onclick="startDrawing()">선 그리기 (Ctrl+L)</button>
  <button onclick="resetPolylines()">선 초기화</button>
  <button onclick="exportGPX()">GPX 내보내기</button>
</div>
<div id="map"></div>
<script>
let map, drawingMode=false, isFirstDraw=true;
let markers=[], polylines=[];
let selectedLatLng=null, currentPolyline=null, currentPath=[];
let geocoder; // reverse geocoder instance

// 맵 초기화 (항공영상)
function initializeMap(center){
  map = new kakao.maps.Map(document.getElementById('map'), {
    center: center,
    level: 4,
    mapTypeId: kakao.maps.MapTypeId.SKYVIEW
  });
  geocoder = new kakao.maps.services.Geocoder();
  map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
  map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

  kakao.maps.event.addListener(map, 'click', e => {
    selectedLatLng = e.latLng;
    document.getElementById('latitude').value = selectedLatLng.getLat();
    document.getElementById('longitude').value = selectedLatLng.getLng();
    // 주소 역지오코딩
    geocoder.coord2Address(
      selectedLatLng.getLng(), selectedLatLng.getLat(),
      (result, status) => {
        if(status === kakao.maps.services.Status.OK) {
          document.getElementById('address-display').value = result[0].address.address_name;
        } else {
          document.getElementById('address-display').value = '';
        }
      }
    );
    if(drawingMode){
      currentPath.push(selectedLatLng);
      currentPolyline.setPath(currentPath);
    }
  });

  kakao.maps.event.addListener(map, 'rightclick', e => {
    if(drawingMode){
      drawingMode=false;
    } else {
      addMarker(e.latLng);
    }
  });
}

// 내 위치 이동
function moveToMyLocation(){
  if(!navigator.geolocation){
    return alert('브라우저가 위치 정보를 지원하지 않습니다.');
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      const ll = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      map.setCenter(ll);
      document.getElementById('latitude').value = pos.coords.latitude;
      document.getElementById('longitude').value = pos.coords.longitude;
      // 주소 업데이트 (옵션)
      geocoder.coord2Address(pos.coords.longitude, pos.coords.latitude, (r, s) => {
        if(s === kakao.maps.services.Status.OK) document.getElementById('address-display').value = r[0].address.address_name;
      });
    },
    err => alert('위치 정보를 가져올 수 없습니다: ' + err.message)
  );
}

// 마커 생성
function addMarker(latlng, presetDesc){
  if(!latlng) return alert('좌표를 먼저 클릭해주세요');
  let desc = (typeof presetDesc === 'string') ? presetDesc : prompt('마커 설명을 입력하세요', '설명 없음');
  if(desc === null) return;
  if(desc.trim() === '') desc = '설명 없음';
  const marker = new kakao.maps.Marker({ map, position: latlng });
  const info = document.createElement('div');
  info.style = 'position:relative;padding:5px 25px 5px 5px;font-size:13px';
  info.innerHTML = desc;
  const closeBtn = document.createElement('div');
  closeBtn.innerHTML = '✖'; closeBtn.style = 'position:absolute;top:5px;right:0;cursor:pointer;font-weight:\
bold';
  info.appendChild(closeBtn);
  const iw = new kakao.maps.InfoWindow({ content: info });
  kakao.maps.event.addListener(marker, 'click', () => iw.open(map, marker));
  closeBtn.onclick = () => iw.close();
  kakao.maps.event.addListener(marker, 'rightclick', () => {
    if(confirm('이 마커를 삭제하시겠습니까?')){
      marker.setMap(null);
      markers = markers.filter(m => m.marker !== marker);
    }
  });
  markers.push({ marker, infowindow: iw, desc });
}

// 폴리라인 그리기
function startDrawing(){
  if(drawingMode){ drawingMode=false; return; }
  drawingMode=true; currentPath=[];
  currentPolyline = new kakao.maps.Polyline({ map, path: currentPath, strokeWeight:3, strokeColor:'#FF0000', strokeOpacity:0.8, strokeStyle:'solid' });
  kakao.maps.event.addListener(currentPolyline, 'rightclick', () => {
    if(confirm('이 경로를 삭제하시겠습니까?')){
      currentPolyline.setMap(null);
      polylines = polylines.filter(p => p !== currentPolyline);
    }
  });
  kakao.maps.event.addListener(currentPolyline, 'mouseover', () => map.getContainer().style.cursor='pointer');
  kakao.maps.event.addListener(currentPolyline, 'mouseout', () => map.getContainer().style.cursor='default');
  polylines.push(currentPolyline);
}

// GPX 드롭 로드 및 기타 기능 (이전 버전과 동일)
// ... 이하 기존 GPX import, resetPolylines, exportGPX, copyCoordinates, 이벤트 바인딩 등 유지 ...

// GPX 파일 드롭 로드
// (원본 코드 그대로 유지하시면 됩니다)

document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('myLocationBtn').addEventListener('click', moveToMyLocation);
  document.getElementById('search-form').addEventListener('submit', e=>{
    e.preventDefault();
    new kakao.maps.services.Geocoder().addressSearch(
      document.getElementById('address-input').value,
      (r,s)=> s===kakao.maps.services.Status.OK? map.setCenter(new kakao.maps.LatLng(r[0].y,r[0].x)) : alert('검색 실패')
    );
  });
});

window.onload = () => {
  if(navigator.geolocation) navigator.geolocation.getCurrentPosition(
    pos => initializeMap(new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude)),
    () => initializeMap(new kakao.maps.LatLng(37.5665,126.9780))
  );
  else initializeMap(new kakao.maps.LatLng(37.5665,126.9780));
};
</script>
</body>
</html>
