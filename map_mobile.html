<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>GPX ë§ˆì»¤ ë° ê²½ë¡œ ì§€ë„ (Mobile)</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94bf4516825c146467eb2318cd55b782&libraries=services"></script>
  <style>
    html, body { height:100%; margin:0; padding:0; overflow:hidden; }
    #map { width:100%; height:100%; position:absolute; top:0; left:0; }

    /* ê²€ìƒ‰ í¼ */
    #search-form {
      position:absolute; top:10px; left:10px; z-index:1000;
      background:white; padding:10px; border-radius:5px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:flex; gap:10px; align-items:center;
    }
    #address-input {
      width:360px; /* ê²€ìƒ‰ì°½ 2ë°° */
      padding:10px;
      font-size:16px;
    }
    #search-form button {
      padding:10px 15px;
      font-size:16px;
    }

    /* ì£¼ì†Œ í‘œì‹œ ë°•ìŠ¤: ê²€ìƒ‰ì°½ ì•„ë˜ì— ê³ ì • */
    #address-display {
      position:absolute;
      top:70px; /* ê²€ìƒ‰ì°½ ì•„ë˜ ìœ„ì¹˜ */
      left:10px;
      z-index:1000;
      background:rgba(0,0,0,0.6);
      color:#fff;
      padding:6px 12px;
      border-radius:4px;
      font-size:14px;
      white-space:nowrap;
      max-width:calc(100% - 20px);
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ì¢Œì¸¡ í•˜ë‹¨ ì»¨íŠ¸ë¡¤ */
    .controls {
      position:absolute; bottom:20px; left:20px; z-index:1000;
      background:white; padding:5px; border-radius:5px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:flex; gap:10px; align-items:center;
    }

    .controls button {
      transform: scale(2);
      transform-origin: center center;
    }

    /* ìš°ì¸¡ ìƒë‹¨ GPX ë²„íŠ¼ */
    .top-controls {
      position:absolute; top:10px; right:10px; z-index:1000;
      background:white; padding:5px; border-radius:5px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:flex; gap:8px; align-items:center;
    }
    .top-controls button {
      padding:6px 10px;
      font-size:14px;
    }

    /* ë‚´ ìœ„ì¹˜ ë²„íŠ¼ í¬ê¸° 2.5ë°° */
    #myLocationBtn {
      position:absolute; bottom:20px; right:20px; z-index:10000;
      background:white; padding:8px; border-radius:50%; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      transform: scale(2.5);
      transform-origin: center center;
    }
  </style>
</head>
<body>
  <form id="search-form">
    <input id="address-input" type="text" placeholder="ì£¼ì†Œ ê²€ìƒ‰" />
    <button type="submit">ê²€ìƒ‰</button>
  </form>

  <div id="address-display">ì£¼ì†Œ ì—†ìŒ</div>

  <div class="top-controls">
    <button id="importBtn">GPX ê°€ì ¸ì˜¤ê¸°</button>
    <button onclick="exportGPX()">GPX ë‚´ë³´ë‚´ê¸°</button>
    <input id="gpx-input" type="file" accept=".gpx" style="display:none" />
  </div>

  <div id="myLocationBtn" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ“</div>

  <div class="controls">
    <button onclick="resetPolylines()">ì„  ì´ˆê¸°í™”</button>
  </div>

  <div id="map"></div>

  <script>
    let map, drawingMode=false;
    let geocoder;
    let markers=[], polylines=[];
    let selectedLatLng, currentPolyline, currentPath=[];

    // GPX ì½ê¸° ê³µí†µ í•¨ìˆ˜
    function loadGPX(file) {
      const reader = new FileReader();
      reader.onload = ev => {
        const xml = new DOMParser().parseFromString(ev.target.result, 'application/xml');
        const bounds = new kakao.maps.LatLngBounds();
        // íŠ¸ë™
        const trkpts = xml.getElementsByTagName('trkpt');
        if (trkpts.length) {
          let arr = [];
          for (let i=0; i<trkpts.length; i++) {
            const lat = parseFloat(trkpts[i].getAttribute('lat'));
            const lon = parseFloat(trkpts[i].getAttribute('lon'));
            const ll = new kakao.maps.LatLng(lat, lon);
            arr.push(ll);
            bounds.extend(ll);
          }
          const poly = new kakao.maps.Polyline({ map, path:arr, strokeWeight:4, strokeColor:'#FF7F00', strokeOpacity:0.9 });
          polylines.push(poly);
        }
        // ì›Œí”„ í¬ì¸íŠ¸
        const wpts = xml.getElementsByTagName('wpt');
        for (let i=0; i<wpts.length; i++) {
          const lat = parseFloat(wpts[i].getAttribute('lat'));
          const lon = parseFloat(wpts[i].getAttribute('lon'));
          const name = wpts[i].getElementsByTagName('name')[0]?.textContent || 'ì„¤ëª… ì—†ìŒ';
          const ll = new kakao.maps.LatLng(lat, lon);
          bounds.extend(ll);
          addMarker(ll, name);
        }
        if (!bounds.isEmpty()) map.setBounds(bounds);
      };
      reader.readAsText(file);
    }

    function initializeMap(center) {
      map = new kakao.maps.Map(document.getElementById('map'), { center, level:4, mapTypeId:kakao.maps.MapTypeId.HYBRID });
      geocoder = new kakao.maps.services.Geocoder();
      map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
      map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);
      // ë“œë˜ê·¸, í´ë¦­ ì´ë²¤íŠ¸
      document.addEventListener('dragover', e => e.preventDefault());
      document.addEventListener('drop', e => { e.preventDefault(); loadGPX(e.dataTransfer.files[0]); });
      // íŒŒì¼ ì„ íƒ
      document.getElementById('importBtn').addEventListener('click', ()=>
        document.getElementById('gpx-input').click()
      );
      document.getElementById('gpx-input').addEventListener('change', e => {
        loadGPX(e.target.files[0]);
      });
      // ì§€ë„ í´ë¦­ -> ì£¼ì†Œ í‘œì‹œ
      kakao.maps.event.addListener(map, 'click', e=>{
        selectedLatLng = e.latLng;
        geocoder.coord2Address(e.latLng.getLng(), e.latLng.getLat(), (res, status)=>{
          const addrEl = document.getElementById('address-display');
          if (status===kakao.maps.services.Status.OK) {
            const legal = res[0].address.address_name;
            const road  = res[0].road_address?.address_name;
            addrEl.innerText = road ? `${legal} / ${road}` : legal;
          } else addrEl.innerText = 'ì£¼ì†Œ ì—†ìŒ';
        });
      });
    }

    function moveToMyLocation() {
      if (!navigator.geolocation) return alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      navigator.geolocation.getCurrentPosition(pos=>{
        const ll = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
        map.setCenter(ll);
      }, err=>alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: '+err.message));
    }

    function addMarker(latlng, presetDesc) {
      const desc = (typeof presetDesc==='string'?presetDesc:prompt('ë§ˆì»¤ ì„¤ëª…','')) || 'ì„¤ëª… ì—†ìŒ';
      const marker = new kakao.maps.Marker({ map, position:latlng });
      const iw = new kakao.maps.InfoWindow({ content:`<div style='padding:5px'>${desc}<span style='float:right;cursor:pointer' onclick='this.parentNode.parentNode.close()'>âœ–</span></div>` });
      kakao.maps.event.addListener(marker, 'click', ()=>iw.open(map, marker));
      markers.push(marker);
    }

    function resetPolylines() {
      polylines.forEach(pl=>pl.setMap(null));
      polylines=[];
    }

    function exportGPX() {
      let gpx = '<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="KakaoMap">\n';
      polylines.forEach((pl,i)=>{
        const path = pl.getPath();
        if (path.length) {
          gpx += `<trk><name>path${i+1}</name><trkseg>` +
                 path.map(pt=>`<trkpt lat="${pt.getLat()}" lon="${pt.getLng()}"/>`).join('') +
                 '</trkseg></trk>\n';
        }
      });
      document.querySelectorAll('#map .marker').forEach((m,i)=>{});
      gpx += '</gpx>';
      const blob = new Blob([gpx], { type:'application/gpx+xml' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = 'export.gpx'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    window.onload = ()=>{
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos=>initializeMap(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude)),
          ()=>initializeMap(new kakao.maps.LatLng(37.5665,126.9780))
        );
      } else initializeMap(new kakao.maps.LatLng(37.5665,126.9780));
    };
  </script>
</body>
</html>
