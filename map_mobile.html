<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>GPX ë§ˆì»¤ ë° ê²½ë¡œ ì§€ë„ (Mobile)</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94bf4516825c146467eb2318cd55b782&libraries=services"></script>
  <style>
    html, body { height:100%; margin:0; padding:0; overflow:hidden; }
    #map { width:100%; height:100%; position:absolute; top:0; left:0; }

    /* ê²€ìƒ‰ í¼ */
    #search-form {
      position:absolute; top:10px; left:10px; z-index:1000;
      background:white; padding:5px; border-radius:5px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:flex; gap:5px; align-items:center;
    }

    /* ì£¼ì†Œ í‘œì‹œ ë°•ìŠ¤: ê²€ìƒ‰ì°½ ì•„ë˜ì— ê³ ì • */
    #address-display {
      position:absolute;
      top:60px; /* ê²€ìƒ‰ì°½ ì•„ë˜ ìœ„ì¹˜ */
      left:10px;
      z-index:1000;
      background:rgba(0,0,0,0.6);
      color:#fff;
      padding:4px 10px;
      border-radius:4px;
      font-size:14px;
      white-space:nowrap;
      max-width:calc(100% - 20px);
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .controls {
      position:absolute; top:10px; right:10px; z-index:1000;
      background:white; padding:5px; border-radius:5px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:flex; gap:6px; align-items:center;
    }

    /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ í¬ê¸° 2ë°° */
    .controls button {
      transform: scale(2);
      transform-origin: center center;
      margin:4px 0;
    }

    /* ë‚´ ìœ„ì¹˜ ë²„íŠ¼ í¬ê¸° 2.5ë°° */
    #myLocationBtn {
      position:absolute; bottom:20px; right:20px; z-index:10000;
      background:white; padding:8px; border-radius:50%; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      transform: scale(2.5);
      transform-origin: center center;
    }
  </style>
</head>
<body>
  <form id="search-form">
    <input id="address-input" type="text" placeholder="ì£¼ì†Œ ê²€ìƒ‰" style="padding:5px; width:180px;"/>
    <button type="submit" style="padding:5px;">ê²€ìƒ‰</button>
  </form>

  <div id="address-display">ì£¼ì†Œ ì—†ìŒ</div>

  <div id="myLocationBtn" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ“</div>

  <div class="controls">
    <button onclick="resetPolylines()">ì„  ì´ˆê¸°í™”</button>
    <button onclick="exportGPX()">GPX ë‚´ë³´ë‚´ê¸°</button>
  </div>

  <div id="map"></div>

  <script>
    let map, drawingMode=false;
    let geocoder;
    let markers=[], polylines=[];
    let selectedLatLng, currentPolyline, currentPath=[];

    function initializeMap(center){
      map = new kakao.maps.Map(document.getElementById('map'), {
        center, level:4, mapTypeId:kakao.maps.MapTypeId.HYBRID
      });
      geocoder = new kakao.maps.services.Geocoder();
      map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
      map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

      kakao.maps.event.addListener(map, 'click', e=>{
        selectedLatLng = e.latLng;

        geocoder.coord2Address(
          selectedLatLng.getLng(), selectedLatLng.getLat(),
          (result, status)=>{
            const addrEl = document.getElementById('address-display');
            if(status===kakao.maps.services.Status.OK){
              const legal = result[0].address.address_name;
              const road  = result[0].road_address?.address_name;
              addrEl.innerText = road ? `${legal} / ${road}` : legal;
            } else {
              addrEl.innerText = 'ì£¼ì†Œ ì—†ìŒ';
            }
          }
        );

        if(drawingMode){
          currentPath.push(selectedLatLng);
          currentPolyline.setPath(currentPath);
        }
      });

      kakao.maps.event.addListener(map, 'rightclick', e=>{
        if(drawingMode){
          drawingMode=false;
        } else {
          addMarker(e.latLng);
        }
      });
    }

    function moveToMyLocation(){
      if(!navigator.geolocation) return alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      navigator.geolocation.getCurrentPosition(
        pos=>{
          const ll=new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
          map.setCenter(ll);
        },
        err=>alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: '+err.message)
      );
    }

    function addMarker(latlng, presetDesc){
      if(!latlng) return alert('ì¢Œí‘œë¥¼ ë¨¼ì € í´ë¦­í•´ì£¼ì„¸ìš”');
      let desc = typeof presetDesc==='string'?presetDesc:prompt('ë§ˆì»¤ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”','ì„¤ëª… ì—†ìŒ');
      if(desc===null) return;
      desc = desc.trim()||'ì„¤ëª… ì—†ìŒ';
      const marker = new kakao.maps.Marker({ map, position:latlng });
      const info = document.createElement('div');
      info.style='position:relative;padding:5px 25px 5px 5px;font-size:13px';
      info.innerHTML = desc;
      const closeBtn = document.createElement('div');
      closeBtn.innerHTML='âœ–';
      closeBtn.style='position:absolute;top:5px;right:0;cursor:pointer;font-weight:bold';
      info.appendChild(closeBtn);
      const iw = new kakao.maps.InfoWindow({ content:info });
      kakao.maps.event.addListener(marker,'click',()=>iw.open(map,marker));
      closeBtn.onclick=()=>iw.close();
      kakao.maps.event.addListener(marker,'rightclick',()=>{
        if(confirm('ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
          marker.setMap(null);
          markers=markers.filter(m=>m.marker!==marker);
        }
      });
      markers.push({ marker, infowindow:iw, desc });
    }

    function startDrawing(){
      if(drawingMode){
        drawingMode=false;
        return;
      }
      drawingMode=true;
      currentPath=[];
      currentPolyline=new kakao.maps.Polyline({
        map, path:currentPath,
        strokeWeight:3, strokeColor:'#FF0000', strokeOpacity:0.8, strokeStyle:'solid'
      });
      kakao.maps.event.addListener(currentPolyline,'rightclick',()=>{
        if(confirm('ì´ ê²½ë¡œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
          currentPolyline.setMap(null);
          polylines=polylines.filter(p=>p!==currentPolyline);
        }
      });
      polylines.push(currentPolyline);
    }

    document.addEventListener('dragover',e=>e.preventDefault());
    document.addEventListener('drop',e=>{
      e.preventDefault();
      const file=e.dataTransfer.files[0];
      if(!file||!file.name.endsWith('.gpx')) return alert('GPX íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
      const reader=new FileReader();
      reader.onload=ev=>{
        const xml=new DOMParser().parseFromString(ev.target.result,'application/xml');
        const bounds=new kakao.maps.LatLngBounds();
        const trkpts=xml.getElementsByTagName('trkpt');
        if(trkpts.length){
          let arr=[];
          for(let i=0;i<trkpts.length;i++){
            const lat=parseFloat(trkpts[i].getAttribute('lat'));
            const lon=parseFloat(trkpts[i].getAttribute('lon'));
            const ll=new kakao.maps.LatLng(lat,lon);
            arr.push(ll); bounds.extend(ll);
          }
          const poly=new kakao.maps.Polyline({
            map, path:arr,
            strokeWeight:4, strokeColor:'#FF7F00', strokeOpacity:0.9, strokeStyle:'solid'
          });
          kakao.maps.event.addListener(poly,'rightclick',()=>{
            if(confirm('ì´ ê²½ë¡œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
              poly.setMap(null);
              polylines=polylines.filter(p=>p!==poly);
            }
          });
          polylines.push(poly);
        }
        const wpts=xml.getElementsByTagName('wpt');
        for(let i=0;i<wpts.length;i++){
          const lat=parseFloat(wpts[i].getAttribute('lat'));
          const lon=parseFloat(wpts[i].getAttribute('lon'));
          const name=wpts[i].getElementsByTagName('name')[0]?.textContent||'ì„¤ëª… ì—†ìŒ';
          const ll=new kakao.maps.LatLng(lat,lon);
          bounds.extend(ll);
          addMarker(ll,name);
        }
        if(!bounds.isEmpty()) map.setBounds(bounds);
      };
      reader.readAsText(file);
    });

    function resetPolylines(){
      polylines.forEach(p=>p.setMap(null));
      polylines=[];
      drawingMode=false;
    }

    function exportGPX(){
      const fname=prompt('íŒŒì¼ëª…','data')||'data';
      let gpx='<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="KakaoMap">';
      polylines.forEach((pl,i)=>{
        const path=pl.getPath();
        if(path.length){
          gpx+=`<trk><name>path${i+1}</name><trkseg>`
             +path.map(pt=>`<trkpt lat="${pt.getLat()}" lon="${pt.getLng()}"></trkpt>`).join('')
             +'</trkseg></trk>';
        }
      });
      markers.forEach((m,i)=>{
        const p=m.marker.getPosition();
        gpx+=`<wpt lat="${p.getLat()}" lon="${p.getLng()}"><name>${m.desc}</name></wpt>`;
      });
      gpx+='</gpx>';
      const blob=new Blob([gpx],{type:'application/gpx+xml'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=fname+'.gpx';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    document.getElementById('search-form').addEventListener('submit',e=>{
      e.preventDefault();
      new kakao.maps.services.Geocoder().addressSearch(
        document.getElementById('address-input').value,
        (r,s)=>{
          if(s===kakao.maps.services.Status.OK){
            map.setCenter(new kakao.maps.LatLng(r[0].y,r[0].x));
          } else {
            alert('ê²€ìƒ‰ ì‹¤íŒ¨');
          }
        }
      );
    });

    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('myLocationBtn')
        .addEventListener('click',moveToMyLocation);
    });

    window.onload=()=>{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          pos=>initializeMap(
            new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude)
          ),
          ()=>initializeMap(new kakao.maps.LatLng(37.5665,126.9780))
        );
      } else {
        initializeMap(new kakao.maps.LatLng(37.5665,126.9780));
      }
    };
  </script>
</body>
</html>