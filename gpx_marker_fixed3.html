<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>GPX ë§ˆì»¤ ë° ê²½ë¡œ ì§€ë„</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94bf4516825c146467eb2318cd55b782&amp;libraries=services"></script>
<style>
    #map { width: 100%; height: 850px; }
    .controls { display: flex; justify-content: space-between; margin-top: 10px; margin-bottom: 10px; }
    #myLocationBtn { position: absolute; bottom: 20px; right: 20px; z-index: 10; background: white; padding: 5px; border-radius: 5px; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
</style>
</head>
<body>
<div id="myLocationBtn" onclick="moveToMyLocation()">ğŸ“ ë‚´ ìœ„ì¹˜ë¡œ ì´ë™</div>
<div class="controls">
    <div>
        <label>ìœ„ë„:</label>
        <input id="latitude" readonly="" size="20" type="text"/>
        <label>ê²½ë„:</label>
        <input id="longitude" readonly="" size="20" type="text"/>
        <button onclick="copyCoordinates()">í´ë¦½ë³´ë“œ ë³µì‚¬ (Ctrl+C)</button>
        <button onclick="startDrawing()">ì„  ê·¸ë¦¬ê¸° (Ctrl+L)</button>
        <button onclick="resetPolyline()">ì„  ì§€ìš°ê¸° (Ctrl+E)</button>
        <button onclick="addMarker(selectedLatLng)">ë§ˆì»¤ ìƒì„± (Ctrl+M)</button>
    </div>
    <button onclick="exportGPX()">GPXë¡œ ë‚´ë³´ë‚´ê¸°</button>
</div>
<div id="map"></div>
<script>
let map, drawingMode = false, isFirstDraw = true;
let polylines = [], markers = [];
let currentLinePath = [], currentPolyline = null;
let selectedLatLng = null;

function initializeMap(center) {
    map = new kakao.maps.Map(document.getElementById('map'), {
        center: center,
        level: 4,
        mapTypeId: kakao.maps.MapTypeId.HYBRID
    });
    map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
    map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        selectedLatLng = mouseEvent.latLng;
        document.getElementById('latitude').value = selectedLatLng.getLat();
        document.getElementById('longitude').value = selectedLatLng.getLng();
        if (drawingMode) {
            currentLinePath.push(selectedLatLng);
            currentPolyline.setPath(currentLinePath);
        }
    });

    kakao.maps.event.addListener(map, 'rightclick', function(mouseEvent) {
        if (drawingMode) {
            drawingMode = false;
        } else {
            // ì‚¬ìš©ìê°€ ë§ˆì»¤ë¥¼ ì¶”ê°€í•  ë•Œ addMarker í•¨ìˆ˜ë¥¼ í˜¸ì¶œ
            addMarker(mouseEvent.latLng);
        }
    });
}

function moveToMyLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const myPos = new kakao.maps.LatLng(lat, lng);
            map.setCenter(myPos);
            selectedLatLng = myPos;
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
        }, () => alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));
    } else {
        alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
}

function startDrawing() {
    if (drawingMode) {
        drawingMode = false;
        alert("ì„  ê·¸ë¦¬ê¸° ëª¨ë“œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        return;
    }
    drawingMode = true;
    currentLinePath = [];
    currentPolyline = new kakao.maps.Polyline({
        map: map, path: currentLinePath,
        strokeWeight: 3, strokeColor: '#FF0000', strokeOpacity: 0.8, strokeStyle: 'solid'
    });
    polylines.push(currentPolyline);
    if (isFirstDraw) {
        alert("ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ê²½ë¡œë¥¼ ê·¸ë¦¬ì„¸ìš”. ìš°í´ë¦­í•˜ë©´ ì„  ê·¸ë¦¬ê¸°ê°€ ì¤‘ë‹¨ë©ë‹ˆë‹¤.");
        isFirstDraw = false;
    }
}

function addMarker(position) {
    if (!position) return alert("ë§ˆì»¤ë¥¼ ì¶”ê°€í•  ìœ„ì¹˜ë¥¼ ë¨¼ì € í´ë¦­í•´ì£¼ì„¸ìš”.");
    const desc = prompt("ë§ˆì»¤ì˜ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”", "ì„¤ëª… ì—†ìŒ");
    const marker = new kakao.maps.Marker({ position, map });
    
    // ì¸í¬ìœˆë„ìš° ë‚´ìš©ì„ DOM ìš”ì†Œë¡œ ìƒì„±
    const contentEl = document.createElement('div');
    contentEl.style.position = 'relative';
    contentEl.style.padding = '5px 25px 5px 5px';
    contentEl.style.fontSize = '13px';
    contentEl.innerHTML = desc;
    
    // ìš°ì¸¡ ëì— ë‹«ê¸°(X) ë²„íŠ¼ ìƒì„±
    const closeBtn = document.createElement('div');
    closeBtn.innerHTML = 'âœ–';
    closeBtn.style.position = 'absolute';
    closeBtn.style.top = '5px';
    closeBtn.style.right = '0px';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.fontWeight = 'bold';
    
    contentEl.appendChild(closeBtn);
    
    const infowindow = new kakao.maps.InfoWindow({
        content: contentEl
    });
    
    kakao.maps.event.addListener(marker, 'click', function() {
        infowindow.open(map, marker);
    });
    
    closeBtn.onclick = function() {
        infowindow.close();
    };

    markers.push({ marker, desc, infowindow });
}

document.addEventListener("DOMContentLoaded", function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            initializeMap(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
            document.getElementById('latitude').value = pos.coords.latitude;
            document.getElementById('longitude').value = pos.coords.longitude;
        }, () => initializeMap(new kakao.maps.LatLng(37.5665, 126.9780)));
    } else {
        initializeMap(new kakao.maps.LatLng(37.5665, 126.9780));
    }

    document.addEventListener("keydown", function(e) {
        if (e.ctrlKey && e.key === 'm') { e.preventDefault(); addMarker(selectedLatLng); }
        if (e.ctrlKey && e.key === 'l') { e.preventDefault(); startDrawing(); }
        if (e.ctrlKey && e.key === 'e') { e.preventDefault(); resetPolyline(); }
        if (e.ctrlKey && e.key === 'c') { e.preventDefault(); copyCoordinates(); }
    });
});

function copyCoordinates() {
    const lat = document.getElementById('latitude').value;
    const lng = document.getElementById('longitude').value;
    navigator.clipboard.writeText(`${lat}, ${lng}`).then(() => alert("ì¢Œí‘œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.")).catch(() => alert("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨"));
}

function exportGPX() {
    let filename = prompt("íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”", "kakao_data");
    if (!filename) return;
    let gpx = '<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="KakaoMap">\n';
    polylines.forEach((line, i) => {
        gpx += `<trk><name>${filename}_${i + 1}</name><trkseg>\n`;
        line.getPath().forEach(pt => gpx += `<trkpt lat="${pt.getLat()}" lon="${pt.getLng()}"></trkpt>\n`);
        gpx += '</trkseg></trk>\n';
    });
    markers.forEach(m => {
        const pos = m.marker.getPosition();
        gpx += `<wpt lat="${pos.getLat()}" lon="${pos.getLng()}"><name>${m.desc}</name></wpt>\n`;
    });
    gpx += '</gpx>';
    const blob = new Blob([gpx], { type: 'application/gpx+xml' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename + '.gpx';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function resetPolyline() {
    polylines.forEach(p => p.setMap(null));
    polylines = [];
    drawingMode = false;
}
</script>
<script>
document.addEventListener('dragover', function(e) {
    e.preventDefault();
});
document.addEventListener('drop', function(e) {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (!file || !file.name.endsWith('.gpx')) {
        alert('GPX íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤.');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(event) {
        const gpxText = event.target.result;
        const parser = new DOMParser();
        const xml = parser.parseFromString(gpxText, "application/xml");

        // íŠ¸ë™í¬ì¸íŠ¸ ì²˜ë¦¬
        const trkpts = xml.getElementsByTagName("trkpt");
        if (trkpts.length > 0) {
            let path = [];
            for (let i = 0; i < trkpts.length; i++) {
                const lat = parseFloat(trkpts[i].getAttribute("lat"));
                const lon = parseFloat(trkpts[i].getAttribute("lon"));
                path.push(new kakao.maps.LatLng(lat, lon));
            }
            const polyline = new kakao.maps.Polyline({
                path: path,
                strokeWeight: 4,
                strokeColor: '#0033FF',
                strokeOpacity: 0.9,
                strokeStyle: 'solid',
                map: map
            });
        }

        // ì›¨ì´í¬ì¸íŠ¸ ì²˜ë¦¬ (GPX íŒŒì¼ì—ì„œ ì¶”ê°€ëœ ë§ˆì»¤)
        const wpts = xml.getElementsByTagName("wpt");
        for (let i = 0; i < wpts.length; i++) {
            const lat = parseFloat(wpts[i].getAttribute("lat"));
            const lon = parseFloat(wpts[i].getAttribute("lon"));
            const name = wpts[i].getElementsByTagName("name")[0]?.textContent || "WayPoint";

            const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(lat, lon),
                map: map
            });

            const iwContent = document.createElement('div');
            iwContent.style.position = 'relative';
            iwContent.style.padding = '5px 25px 5px 5px';
            iwContent.style.fontSize = '13px';
            iwContent.innerHTML = name;

            const closeBtn = document.createElement('div');
            closeBtn.innerHTML = 'âœ–';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '5px';
            closeBtn.style.right = '0px';
            closeBtn.style.cursor = 'pointer';
            closeBtn.style.fontWeight = 'bold';

            iwContent.appendChild(closeBtn);

            const infowindow = new kakao.maps.InfoWindow({
                content: iwContent
            });

            closeBtn.onclick = function () {
                infowindow.close();
            };

            kakao.maps.event.addListener(marker, 'click', function() {
                infowindow.open(map, marker);
            });
        }
    };
    reader.readAsText(file);
});
</script>
<!-- ìˆ˜ë™ ë§ˆì»¤ ìƒì„± ì˜ˆì‹œ: ì˜¤ë¥¸ìª½ í´ë¦­ ì‹œ ìƒì„±ë˜ëŠ” ë§ˆì»¤ì— ëŒ€í•´ ì¸í¬ìœˆë„ìš° DOM ìš”ì†Œë¥¼ ì‚¬ìš© -->
<script>
kakao.maps.event.addListener(map, 'rightclick', function(mouseEvent) {
    if (drawingMode) {
        drawingMode = false;
        return; // ì„  ê·¸ë¦¬ê¸° ëª¨ë“œ í•´ì œ ì „ìš©
    }

    const latlng = mouseEvent.latLng;

    const marker = new kakao.maps.Marker({
        position: latlng,
        map: map
    });

    // ì¸í¬ìœˆë„ìš° ë‚´ìš©ì„ DOM ìš”ì†Œë¡œ êµ¬ì„± (ì„¤ëª… ì—†ìŒ)
    const contentEl = document.createElement('div');
    contentEl.style.position = 'relative';
    contentEl.style.padding = '5px 25px 5px 5px';
    contentEl.style.fontSize = '13px';
    contentEl.innerHTML = "ì„¤ëª… ì—†ìŒ";

    // ì˜¤ë¥¸ìª½ ëì— ë‹«ê¸°(X) ë²„íŠ¼ ì¶”ê°€
    const closeBtn = document.createElement('div');
    closeBtn.innerHTML = 'âœ–';
    closeBtn.style.position = 'absolute';
    closeBtn.style.top = '5px';
    closeBtn.style.right = '0px';
    closeBtn.style.cursor = 'pointer';
    closeBtn.style.fontWeight = 'bold';
    
    contentEl.appendChild(closeBtn);

    const infowindow = new kakao.maps.InfoWindow({
        position: latlng,
        content: contentEl
    });

    kakao.maps.event.addListener(marker, 'click', function() {
        infowindow.open(map, marker);
    });
    
    closeBtn.onclick = function() {
        infowindow.close();
    };
});
</script>
</body>
</html>
