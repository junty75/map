<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>GPX ë§ˆì»¤ ë° ê²½ë¡œ ì§€ë„ (v12)</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94bf4516825c146467eb2318cd55b782&libraries=services"></script>
  <style>
    html, body { height:100%; margin:0; padding:0; overflow:hidden; }
    #map { width:100%; height:100%; position:absolute; top:0; left:0; }

    /* ê²€ìƒ‰ í¼ */
    #search-form {
      position:absolute; top:10px; left:10px; z-index:1000;
      background:white; padding:5px; border-radius:5px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:flex; gap:5px; align-items:center;
    }

    /* ìƒˆë¡œ ì¶”ê°€: ì£¼ì†Œ í‘œì‹œ ë¼ë²¨ */
    #address-display {
      position:absolute;
      top:10px;
      /* ê²€ìƒ‰ì°½ ë„ˆë¹„(180px) + ë²„íŠ¼ ëŒ€ëµ 40px + ê°„ê²© 5px = 225px,
         + left ë§ˆì§„ 10px â†’ ì•½ 235px */
      left:235px;
      z-index:1000;
      background:rgba(0,0,0,0.6);
      color:#fff;
      padding:2px 8px;
      border-radius:4px;
      font-size:12px;
      white-space:nowrap;
    }

    /* ìš°ì¸¡ ì»¨íŠ¸ë¡¤ë“¤ (ì£¼ì†Œ í•­ëª© ì œê±°ë¨) */
    .controls {
      position:absolute; top:10px; right:10px; z-index:1000;
      background:white; padding:5px; border-radius:5px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:flex; gap:6px; align-items:center;
    }

    #myLocationBtn {
      position:absolute; bottom:20px; right:20px; z-index:10000;
      background:white; padding:8px; border-radius:50%; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <!-- ê²€ìƒ‰ í¼ -->
  <form id="search-form">
    <input id="address-input" type="text" placeholder="ì£¼ì†Œ ê²€ìƒ‰" style="padding:5px; width:180px;"/>
    <button type="submit" style="padding:5px;">ê²€ìƒ‰</button>
  </form>

  <!-- ìƒˆë¡œ ì¶”ê°€: ê²€ìƒ‰ ì˜†ì— ì–´ë‘ìš´ ë°•ìŠ¤ë¡œ ì£¼ì†Œ í‘œì‹œ -->
  <div id="address-display">ì£¼ì†Œ ì—†ìŒ</div>

  <div id="myLocationBtn" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ“</div>

  <div class="controls">
    <label>ìœ„ë„:</label><input id="latitude" readonly size="12"/>
    <label>ê²½ë„:</label><input id="longitude" readonly size="12"/>
    <button onclick="copyCoordinates()">ë³µì‚¬ (Ctrl+C)</button>
    <button onclick="startDrawing()">ì„  ê·¸ë¦¬ê¸° (Ctrl+L)</button>
    <button onclick="resetPolylines()">ì„  ì´ˆê¸°í™”</button>
    <!-- <label>ì£¼ì†Œ:</label><input id="address-display" readonly size="30"/> -->
    <button onclick="exportGPX()">GPX ë‚´ë³´ë‚´ê¸°</button>
  </div>

  <div id="map"></div>

  <script>
    let map, drawingMode=false, isFirstDraw=true;
    let geocoder;
    let markers=[], polylines=[];
    let selectedLatLng=null, currentPolyline=null, currentPath=[];

    function initializeMap(center){
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: center, level: 4, mapTypeId: kakao.maps.MapTypeId.SKYVIEW
      });
      geocoder = new kakao.maps.services.Geocoder();
      map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
      map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

      kakao.maps.event.addListener(map, 'click', e => {
        selectedLatLng = e.latLng;
        document.getElementById('latitude').value = selectedLatLng.getLat();
        document.getElementById('longitude').value = selectedLatLng.getLng();

        geocoder.coord2Address(
          selectedLatLng.getLng(), selectedLatLng.getLat(),
          function(result, status) {
            const addrEl = document.getElementById('address-display');
            if (status === kakao.maps.services.Status.OK) {
              addrEl.innerText = result[0].address.address_name;
            } else {
              addrEl.innerText = 'ì£¼ì†Œ ì—†ìŒ';
            }
          }
        );

        if(drawingMode){
          currentPath.push(selectedLatLng);
          currentPolyline.setPath(currentPath);
        }
      });

      kakao.maps.event.addListener(map, 'rightclick', e => {
        if(drawingMode){
          drawingMode=false;
        } else {
          addMarker(e.latLng);
        }
      });
    }

    function moveToMyLocation(){
      if(!navigator.geolocation){
        return alert('ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const ll = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          map.setCenter(ll);
          document.getElementById('latitude').value = pos.coords.latitude;
          document.getElementById('longitude').value = pos.coords.longitude;
        },
        err => alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message)
      );
    }

    function addMarker(latlng, presetDesc){
      if(!latlng) return alert('ì¢Œí‘œë¥¼ ë¨¼ì € í´ë¦­í•´ì£¼ì„¸ìš”');
      let desc = (typeof presetDesc === 'string') ? presetDesc : prompt('ë§ˆì»¤ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'ì„¤ëª… ì—†ìŒ');
      if(desc === null) return;
      if(desc.trim() === '') desc = 'ì„¤ëª… ì—†ìŒ';
      const marker = new kakao.maps.Marker({ map, position: latlng });
      const info = document.createElement('div');
      info.style = 'position:relative;padding:5px 25px 5px 5px;font-size:13px';
      info.innerHTML = desc;
      const closeBtn = document.createElement('div');
      closeBtn.innerHTML = 'âœ–';
      closeBtn.style = 'position:absolute;top:5px;right:0;cursor:pointer;font-weight:bold';
      info.appendChild(closeBtn);
      const iw = new kakao.maps.InfoWindow({ content: info });
      kakao.maps.event.addListener(marker, 'click', () => iw.open(map, marker));
      closeBtn.onclick = () => iw.close();
      kakao.maps.event.addListener(marker, 'rightclick', () => {
        if(confirm('ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
          marker.setMap(null);
          markers = markers.filter(m => m.marker !== marker);
        }
      });
      markers.push({ marker, infowindow: iw, desc });
    }

    function startDrawing(){
      if(drawingMode){
        drawingMode=false; 
        return;
      }
      drawingMode=true; currentPath=[];
      currentPolyline = new kakao.maps.Polyline({
        map, path: currentPath,
        strokeWeight: 3, strokeColor: '#FF0000', strokeOpacity: 0.8, strokeStyle: 'solid'
      });
      kakao.maps.event.addListener(currentPolyline, 'rightclick', () => {
        if(confirm('ì´ ê²½ë¡œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
          currentPolyline.setMap(null);
          polylines = polylines.filter(p => p !== currentPolyline);
        }
      });
      kakao.maps.event.addListener(currentPolyline, 'mouseover', () => map.getContainer().style.cursor = 'pointer');
      kakao.maps.event.addListener(currentPolyline, 'mouseout', () => map.getContainer().style.cursor = 'default');
      polylines.push(currentPolyline);
    }

    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0];
      if(!file || !file.name.endsWith('.gpx')) return alert('GPX íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
      const reader = new FileReader();
      reader.onload = ev => {
        const xml = new DOMParser().parseFromString(ev.target.result, 'application/xml');
        const bounds = new kakao.maps.LatLngBounds();
        // íŠ¸ë™í¬ì¸íŠ¸ ì²˜ë¦¬
        const trkpts = xml.getElementsByTagName('trkpt');
        if(trkpts.length){
          let arr = [];
          for(let i=0; i<trkpts.length; i++){
            const lat = parseFloat(trkpts[i].getAttribute('lat'));
            const lon = parseFloat(trkpts[i].getAttribute('lon'));
            const ll = new kakao.maps.LatLng(lat, lon);
            arr.push(ll); bounds.extend(ll);
          }
          const poly = new kakao.maps.Polyline({
            map, path: arr, strokeWeight:4,
            strokeColor: '#FF7F00', strokeOpacity:0.9, strokeStyle:'solid'
          });
          kakao.maps.event.addListener(poly, 'rightclick', () => {
            if(confirm('ì´ ê²½ë¡œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){
              poly.setMap(null);
              polylines = polylines.filter(p => p !== poly);
            }
          });
          polylines.push(poly);
        }
        // ì›¨ì´í¬ì¸íŠ¸ ì²˜ë¦¬
        const wpts = xml.getElementsByTagName('wpt');
        for(let i=0; i<wpts.length; i++){
          const lat = parseFloat(wpts[i].getAttribute('lat'));
          const lon = parseFloat(wpts[i].getAttribute('lon'));
          const name = wpts[i].getElementsByTagName('name')[0]?.textContent || 'ì„¤ëª… ì—†ìŒ';
          const ll = new kakao.maps.LatLng(lat, lon);
          bounds.extend(ll);
          addMarker(ll, name);
        }
        if(!bounds.isEmpty()) map.setBounds(bounds);
      };
      reader.readAsText(file);
    });

    function resetPolylines(){ polylines.forEach(p=>p.setMap(null)); polylines=[]; drawingMode=false; }

    function exportGPX(){
      const fname = prompt('íŒŒì¼ëª…','data')||'data';
      let gpx = '<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="KakaoMap">\n';
      polylines.forEach((pl,i)=>{
        const path=pl.getPath(); 
        if(path.length){
          gpx += `<trk><name>path${i+1}</name><trkseg>\n`
               + path.map(pt=>`<trkpt lat="${pt.getLat()}" lon="${pt.getLng()}"></trkpt>\n`).join('')
               + '</trkseg></trk>\n';
        }
      });
      markers.forEach((m,i)=>{
        const p = m.marker.getPosition();
        gpx += `<wpt lat="${p.getLat()}" lon="${p.getLng()}"><name>${m.desc}</name></wpt>\n`;
      });
      gpx += '</gpx>';
      const blob = new Blob([gpx],{type:'application/gpx+xml'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fname+'.gpx';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function copyCoordinates() {
      const coords = document.getElementById('latitude').value + ', ' + document.getElementById('longitude').value;
      navigator.clipboard.writeText(coords);
    }

    document.getElementById('search-form').addEventListener('submit', e => {
      e.preventDefault();
      new kakao.maps.services.Geocoder().addressSearch(
        document.getElementById('address-input').value,
        (r,s) => {
          if(s === kakao.maps.services.Status.OK) {
            map.setCenter(new kakao.maps.LatLng(r[0].y, r[0].x));
          } else {
            alert('ê²€ìƒ‰ ì‹¤íŒ¨');
          }
        }
      );
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('myLocationBtn').addEventListener('click', moveToMyLocation);
    });

    window.onload = () => {
      if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => initializeMap(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude)),
          () => initializeMap(new kakao.maps.LatLng(37.5665,126.9780))
        );
      } else {
        initializeMap(new kakao.maps.LatLng(37.5665,126.9780));
      }
    };
  </script>
</body>
</html>
