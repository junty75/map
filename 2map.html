<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>GPX & ì‚¬ì§„ ì§€ë„ (v3.2)</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94bf4516825c146467eb2318cd55b782&libraries=services,geometry"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    html, body { height:100%; margin:0; overflow:hidden; }
    #map { width:100%; height:100%; }
    #search-form, #address-display, .controls, #myLocationBtn {
      position:absolute; background:white; padding:5px; border-radius:5px; box-shadow:0 2px 6px rgba(0,0,0,0.3); z-index:1000;
    }
    #search-form { top:10px; left:10px; display:flex; gap:5px; }
    #address-display { top:10px; left:260px; background:rgba(0,0,0,0.6); color:white; font-size:12px; white-space:nowrap; overflow:hidden; }
    .controls { top:10px; right:10px; display:flex; gap:6px; }
    #myLocationBtn { bottom:20px; right:20px; border-radius:50%; }
  </style>
</head>
<body>
  <form id="search-form">
    <input id="address-input" type="text" placeholder="ì£¼ì†Œ ê²€ìƒ‰" style="padding:5px; width:180px;">
    <button type="submit" style="padding:5px;">ê²€ìƒ‰</button>
  </form>
  <div id="address-display">ì£¼ì†Œ ì—†ìŒ</div>
  <div id="myLocationBtn" title="ë‚´ ìœ„ì¹˜ë¡œ ì´ë™">ğŸ“</div>
  <div class="controls">
    <label>ìœ„ë„:</label><input id="latitude" readonly size="12">
    <label>ê²½ë„:</label><input id="longitude" readonly size="12">
    <button type="button" onclick="copyCoordinates()">ë³µì‚¬ (Ctrl+C)</button>
    <button type="button" onclick="startDrawing()">ì„  ê·¸ë¦¬ê¸° (Alt)</button>
    <button type="button" onclick="resetPolylines()">ì„  ì´ˆê¸°í™”</button>
    <button type="button" onclick="resetAll()">í™”ë©´ ì´ˆê¸°í™”</button>
    <button type="button" onclick="exportGPX()">GPX ë‚´ë³´ë‚´ê¸°</button>
  </div>
  <div id="map"></div>

<script>
let map, geocoder, drawingMode = false;
let markers = [], polylines = [], markerInputOverlay = null;
let currentPolyline, currentPath = [];
let searchMarker = null;
let distanceOverlay = null;
let mouseMoveListener = null;
let clickListener = null;

const trimCityProvince = str => str?.split(' ').slice(1).join(' ') || '';

function initializeMap(center) {
  map = new kakao.maps.Map(document.getElementById('map'), { center, level: 4, mapTypeId: kakao.maps.MapTypeId.HYBRID });
  geocoder = new kakao.maps.services.Geocoder();

  kakao.maps.event.addListener(map, 'click', e => {
    if (markerInputOverlay) {
      markerInputOverlay.setMap(null);
      markerInputOverlay = null;
      return;
    }
    if (drawingMode) {
      currentPath.push(e.latLng);
      currentPolyline.setPath(currentPath);
    } else {
      markers.forEach(m => m.iw.close());
      document.getElementById('latitude').value = e.latLng.getLat();
      document.getElementById('longitude').value = e.latLng.getLng();
      geocoder.coord2Address(e.latLng.getLng(), e.latLng.getLat(), (res, status) => {
        const el = document.getElementById('address-display');
        if (status === kakao.maps.services.Status.OK) {
          const legal = res[0].address?.address_name || 'ì£¼ì†Œ ì—†ìŒ';
          const roadFull = res[0].road_address?.address_name;
          const road = roadFull ? roadFull.split(' ').slice(1).join(' ') : '';
          el.innerText = road ? `${legal} / ${road}` : legal;
        } else {
          el.innerText = 'ì£¼ì†Œ ì—†ìŒ';
        }
      });
    }
  });

  kakao.maps.event.addListener(map, 'rightclick', e => {
    if (drawingMode) {
      drawingMode = false;
    } else {
      showMarkerInput(e.latLng);
    }
  });

  // ì£¼ì†Œ ê²€ìƒ‰
  document.getElementById('search-form').addEventListener('submit', e => {
    e.preventDefault();
    const keyword = document.getElementById('address-input').value;
    geocoder.addressSearch(keyword, (res, status) => {
      if (status === kakao.maps.services.Status.OK) {
        const pos = new kakao.maps.LatLng(res[0].y, res[0].x);
        map.setCenter(pos);

        // ì´ì „ì— ìƒì„±í•œ ê²€ìƒ‰ ë§ˆì»¤ê°€ ìˆìœ¼ë©´ ì œê±°
        if (searchMarker) {
          searchMarker.setMap(null);
        }
        // ìƒˆ ê²€ìƒ‰ ë§ˆì»¤ ìƒì„±
        searchMarker = new kakao.maps.Marker({
          map,
          position: pos
        });
      } else {
        alert('ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
    });
  });

  // Ctrl+C, Alt ë‹¨ì¶•í‚¤
  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key.toLowerCase() === 'c') {
      e.preventDefault();
      copyCoordinates();
    }
    if (e.altKey) {
      e.preventDefault();
      startDrawing();
    }
  });

  // ë‚´ ìœ„ì¹˜ ë²„íŠ¼ (ğŸ“) ë³µêµ¬
  document.getElementById('myLocationBtn').onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
      const ll = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      map.setCenter(ll);
      document.getElementById('latitude').value = pos.coords.latitude;
      document.getElementById('longitude').value = pos.coords.longitude;
    }, err => {
      alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + err.message);
    });
  };
}
function showMarkerInput(latlng) {
  if (markerInputOverlay) markerInputOverlay.setMap(null);

  const container = document.createElement('div');
  container.innerHTML = `<input type="text" placeholder="ë§ˆì»¤ ì´ë¦„" style="width:120px;padding:3px;">
                         <button style="margin-top:4px;">ì¶”ê°€</button>
                         <button style="margin-top:4px;">ì·¨ì†Œ</button>`;
  container.style = 'background:white;padding:6px;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:flex;flex-direction:column;gap:4px;';
  
  markerInputOverlay = new kakao.maps.CustomOverlay({ position: latlng, content: container, yAnchor: 1 });
  markerInputOverlay.setMap(map);

  container.addEventListener('mousedown', e => e.stopPropagation());

  const [input, addBtn, cancelBtn] = container.querySelectorAll('input, button');
  input.focus();
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addBtn.click();
    }
  });

  addBtn.onclick = () => {
    const text = input.value.trim() || 'ì„¤ëª… ì—†ìŒ';
    addMarker(latlng, text);
    markerInputOverlay.setMap(null);
  };
  cancelBtn.onclick = () => markerInputOverlay.setMap(null);
}

function addMarker(latlng, desc) {
  const marker = new kakao.maps.Marker({ map, position: latlng });
  const div = document.createElement('div');
  div.style = 'position:relative; display:flex; align-items:center; justify-content:space-between; padding:5px;';
  div.innerHTML = `<span>${desc}</span><div style="cursor:pointer; font-weight:bold;">âœ–</div>`;
  const [label, btn] = div.querySelectorAll('span, div');
  const iw = new kakao.maps.InfoWindow({ content: div });

  kakao.maps.event.addListener(marker, 'click', () => iw.open(map, marker));
  kakao.maps.event.addListener(marker, 'rightclick', () => showEditInput({ marker, iw, name: desc }, label));
  btn.onclick = () => iw.close();

  markers.push({ marker, iw, name: desc });
}

function addPhotoMarker(latlng, imgSrc, filename) {
  const marker = new kakao.maps.Marker({ map, position: latlng });
  const div = document.createElement('div');
  div.style = 'position:relative; padding:5px;';
  div.innerHTML = `
    <div style="font-weight:bold; margin-bottom:5px;">${filename}</div>
    <div style="position:absolute; top:2px; right:2px; cursor:pointer;">âœ–</div>
    <img src="${imgSrc}" style="max-height:360px; display:block;">
  `;
  const [title, btn] = div.querySelectorAll('div');

  const iw = new kakao.maps.InfoWindow({ content: div });

  kakao.maps.event.addListener(marker, 'click', () => iw.open(map, marker));
  kakao.maps.event.addListener(marker, 'rightclick', () => showEditInput({ marker, iw, name: filename }, title));
  btn.onclick = () => iw.close();

  markers.push({ marker, iw, name: filename });
}

function showEditInput(markerObj, label) {
  if (markerInputOverlay) markerInputOverlay.setMap(null);

  const container = document.createElement('div');
  container.innerHTML = `<input type="text" value="${label.textContent}" style="width:120px;padding:3px;">
                         <button style="margin-top:4px;">ìˆ˜ì •</button>
                         <button style="margin-top:4px;">ì‚­ì œ</button>`;
  container.style = 'background:white;padding:6px;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:flex;flex-direction:column;gap:4px;';

  markerInputOverlay = new kakao.maps.CustomOverlay({ position: markerObj.marker.getPosition(), content: container, yAnchor: 1 });
  markerInputOverlay.setMap(map);

  container.addEventListener('mousedown', e => e.stopPropagation());

  const [input, editBtn, deleteBtn] = container.querySelectorAll('input, button');
  input.focus();
  const val = input.value;
  input.value = '';
  input.value = val;
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      editBtn.click();
    }
  });

  editBtn.onclick = () => {
    label.textContent = input.value.trim() || 'ì„¤ëª… ì—†ìŒ';
    markerObj.name = label.textContent;
    markerInputOverlay.setMap(null);
  };
  deleteBtn.onclick = () => {
    markerObj.marker.setMap(null);
    markerObj.iw.close();
    markerInputOverlay.setMap(null);
  };
}

function copyCoordinates() {
  const lat = document.getElementById('latitude').value;
  const lng = document.getElementById('longitude').value;
  navigator.clipboard.writeText(`${lat}, ${lng}`);
}

function startDrawing() {
  if (drawingMode) {
    // ê·¸ë¦¬ê¸° ì¢…ë£Œ
    drawingMode = false;
    if (distanceOverlay) {
      distanceOverlay.setMap(null);
      distanceOverlay = null;
    }
    if (mouseMoveListener) {
      kakao.maps.event.removeListener(mouseMoveListener);
      mouseMoveListener = null;
    }
    return;
  }

  // ê·¸ë¦¬ê¸° ì‹œì‘
  drawingMode = true;
  currentPath = [];
  currentPolyline = new kakao.maps.Polyline({
    map: map,
    path: currentPath,
    strokeWeight: 3,
    strokeColor: '#FF0000',
    strokeOpacity: 0.8
  });
  polylines.push(currentPolyline);

  // (1) ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ìƒì„± â†’ setMapìœ¼ë¡œ ì§€ë„ì— ì˜¬ë¦¬ê¸°
  distanceOverlay = new kakao.maps.CustomOverlay({
    position: map.getCenter(),          // ì´ˆê¸°ì—” ë§µ ì¤‘ì•™
    content: `<div style="
                 padding:4px;
                 background:rgba(255,255,255,0.8);
                 border:1px solid #666;
                 font-size:12px;
               ">ê±°ë¦¬: 0 m</div>`,
    yAnchor: 1                          // ë§ˆìš°ìŠ¤ ë°”ë¡œ ìœ„ì— í‘œì‹œ
  });
  distanceOverlay.setMap(map);

  // (2) mousemove ì´ë²¤íŠ¸ë¡œ updateDistance í˜¸ì¶œ
  mouseMoveListener = kakao.maps.event.addListener(
    map,
    'mousemove',
    updateDistance
  );
}

const resetPolylines = () => { polylines.forEach(p => p.setMap(null)); polylines = []; drawingMode = false; };
const resetAll = () => { markers.forEach(m => m.marker.setMap(null)); markers = []; resetPolylines(); };


function updateDistance(mouseEvent) {
  if (!distanceOverlay) return;
  const mover = mouseEvent.latLng;
  let dist = 0;
  if (currentPath.length > 0) {
    // ëˆ„ì ê±°ë¦¬ + ë§ˆì§€ë§‰ì ~ë§ˆìš°ìŠ¤ê±°ë¦¬
    for (let i = 1; i < currentPath.length; i++) {
      dist += kakao.maps.geometry.spherical.computeDistanceBetween(
        currentPath[i - 1],
        currentPath[i]
      );
    }
    dist += kakao.maps.geometry.spherical.computeDistanceBetween(
      currentPath[currentPath.length - 1],
      mover
    );
  }
  // ì˜¤ë²„ë ˆì´ ìœ„ì¹˜Â·ë‚´ìš© ê°±ì‹ 
  distanceOverlay.setPosition(mover);
  distanceOverlay.setContent(
    `<div style="
       padding:4px;
       background:rgba(255,255,255,0.8);
       border:1px solid #666;
       font-size:12px;
     ">ê±°ë¦¬: ${Math.round(dist)} m</div>`
  );
}

function exportGPX() {
  const fname = prompt('íŒŒì¼ëª…', 'data'); if (!fname) return;
  let gpx = '<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="KakaoMap">\n';
  polylines.forEach((pl,i)=>{ gpx += `<trk><name>path${i+1}</name><trkseg>\n` + pl.getPath().map(p=>`<trkpt lat="${p.getLat()}" lon="${p.getLng()}"></trkpt>\n`).join('') + '</trkseg></trk>\n'; });
  markers.forEach(m => {
    const p = m.marker.getPosition();
    gpx += `<wpt lat="${p.getLat()}" lon="${p.getLng()}"><name>${m.name || ''}</name></wpt>\n`;
  });
  gpx += '</gpx>';
  const blob = new Blob([gpx], { type: 'application/gpx+xml' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fname + '.gpx';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// íŒŒì¼ ë“œë˜ê·¸ë¡œ ì‚¬ì§„/GPX ì—…ë¡œë“œ
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  const files = Array.from(e.dataTransfer.files);
  if (!files.length) return;
  const bounds = new kakao.maps.LatLngBounds();

  files.forEach(file => {
    // 1) GPX íŠ¸ë™(seg) ê·¸ë¦¬ê¸°
    if (file.name.toLowerCase().endsWith('.gpx')) {
      const reader = new FileReader();
      reader.onload = ev => {
        const xml = new DOMParser().parseFromString(ev.target.result, 'application/xml');
        const trksegs = xml.getElementsByTagName('trkseg');
        Array.from(trksegs).forEach(seg => {
          const pts = Array.from(seg.getElementsByTagName('trkpt')).map(pt => {
            const ll = new kakao.maps.LatLng(
              parseFloat(pt.getAttribute('lat')),
              parseFloat(pt.getAttribute('lon'))
            );
            bounds.extend(ll);
            return ll;
          });
          if (pts.length) {
            const poly = new kakao.maps.Polyline({
              map, path: pts,
              strokeWeight: 4, strokeColor: '#FF7F00', strokeOpacity: 0.9
            });
            polylines.push(poly);
          }
        });
        Array.from(xml.getElementsByTagName('wpt')).forEach(wpt => {
          const ll = new kakao.maps.LatLng(
            parseFloat(wpt.getAttribute('lat')),
            parseFloat(wpt.getAttribute('lon'))
          );
          bounds.extend(ll);
          addMarker(ll, wpt.getElementsByTagName('name')[0]?.textContent || 'ì„¤ëª… ì—†ìŒ');
        });
        if (!bounds.isEmpty()) map.setBounds(bounds);
      };
      reader.readAsText(file);

    // 2) ì´ë¯¸ì§€(EXIF) â†’ ë§ˆì»¤
    } else if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = ev => {
        const img = new Image();
        img.onload = () => {
          EXIF.getData(img, function() {
            const lat = EXIF.getTag(this, 'GPSLatitude');
            const lon = EXIF.getTag(this, 'GPSLongitude');
            const latRef = EXIF.getTag(this, 'GPSLatitudeRef');
            const lonRef = EXIF.getTag(this, 'GPSLongitudeRef');
            if (lat && lon && latRef && lonRef) {
              const conv = (dms, ref) =>
                (dms[0] + dms[1]/60 + dms[2]/3600) * (ref === 'S' || ref === 'W' ? -1 : 1);
              const ll = new kakao.maps.LatLng(
                conv(lat, latRef),
                conv(lon, lonRef)
              );
              bounds.extend(ll);
              addPhotoMarker(ll, ev.target.result, file.name.replace(/\.[^/.]+$/, ''));
              if (!bounds.isEmpty()) map.setBounds(bounds);
            }
          });
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    }
  });
});

window.onload = () => {
  navigator.geolocation.getCurrentPosition(
    pos => initializeMap(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude)),
    () => initializeMap(new kakao.maps.LatLng(37.5665, 126.9780))
  );
};
</script>
</body>
</html>
