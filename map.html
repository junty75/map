<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>GPX & 사진 드래그 지도 (v15)</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94bf4516825c146467eb2318cd55b782&libraries=services"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    html, body { height:100%; margin:0; padding:0; overflow:hidden; }
    #map { width:100%; height:100%; position:absolute; top:0; left:0; }

    #search-form {
      position:absolute; top:10px; left:10px; z-index:1000;
      background:white; padding:5px; border-radius:5px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:flex; gap:5px; align-items:center;
    }
    #address-display {
      position:absolute; top:10px; left:260px; z-index:1000;
      background:rgba(0,0,0,0.6); color:#fff;
      padding:2px 8px; border-radius:4px; font-size:12px;
      white-space:nowrap; max-width:500px;
      overflow:hidden; text-overflow:ellipsis;
    }
    .controls {
      position:absolute; top:10px; right:10px; z-index:1000;
      background:white; padding:5px; border-radius:5px;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
      display:flex; gap:6px; align-items:center;
    }
    #myLocationBtn {
      position:absolute; bottom:20px; right:20px; z-index:10000;
      background:white; padding:8px; border-radius:50%; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
  <form id="search-form">
    <input id="address-input" type="text" placeholder="주소 검색" style="padding:5px; width:180px;"/>
    <button type="submit" style="padding:5px;">검색</button>
  </form>
  <div id="address-display">주소 없음</div>
  <div id="myLocationBtn" title="내 위치로 이동">📍</div>

  <div class="controls">
    <label>위도:</label><input id="latitude" readonly size="12"/>
    <label>경도:</label><input id="longitude" readonly size="12"/>
    <button onclick="copyCoordinates()">복사 (Ctrl+C)</button>
    <button onclick="startDrawing()">선 그리기 (Ctrl+L)</button>
    <button onclick="resetPolylines()">선 초기화</button>
    <button onclick="exportGPX()">GPX 내보내기</button>
  </div>

  <div id="map"></div>

  <script>
    let map, geocoder, drawingMode = false;
    let markers = [], polylines = [], markerInputOverlay = null;
    let currentPolyline, currentPath = [];

    function initializeMap(center) {
      map = new kakao.maps.Map(document.getElementById('map'), {
        center, level: 4,
        mapTypeId: kakao.maps.MapTypeId.HYBRID
      });
      geocoder = new kakao.maps.services.Geocoder();

      kakao.maps.event.addListener(map, 'click', e => {
        document.getElementById('latitude').value = e.latLng.getLat();
        document.getElementById('longitude').value = e.latLng.getLng();
        geocoder.coord2Address(
          e.latLng.getLng(), e.latLng.getLat(),
          (res, status) => {
            const el = document.getElementById('address-display');
            if (status === kakao.maps.services.Status.OK) {
              const legal = res[0].address.address_name;
              const road  = res[0].road_address?.address_name;
              el.innerText = road ? `${legal} / ${road}` : legal;
            } else el.innerText = '주소 없음';
          }
        );
        if (drawingMode) {
          currentPath.push(e.latLng);
          currentPolyline.setPath(currentPath);
        }
      });

      kakao.maps.event.addListener(map, 'rightclick', e => {
        if (drawingMode) {
          drawingMode = false;
        } else {
          showMarkerInput(e.latLng);
        }
      });
    }

    function showMarkerInput(latlng) {
      if (markerInputOverlay) markerInputOverlay.setMap(null);
      const container = document.createElement('div');
      container.style = 'background:white;padding:6px;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.3);';
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = '마커 이름';
      input.style = 'width:120px;padding:3px;';
      const addBtn = document.createElement('button');
      addBtn.textContent = '추가';
      addBtn.style = 'margin-left:4px;';
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = '취소';
      cancelBtn.style = 'margin-left:4px;';
      container.append(input, addBtn, cancelBtn);

      markerInputOverlay = new kakao.maps.CustomOverlay({
        position: latlng,
        content: container,
        yAnchor: 1
      });
      markerInputOverlay.setMap(map);

      addBtn.onclick = () => {
        const name = input.value.trim() || '설명 없음';
        addMarker(latlng, name);
        markerInputOverlay.setMap(null);
      };
      cancelBtn.onclick = () => markerInputOverlay.setMap(null);
    }

    // GPX + 이미지 드래그 복원
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => {
      e.preventDefault();
      const files = Array.from(e.dataTransfer.files);
      if (!files.length) return;
      const bounds = new kakao.maps.LatLngBounds();

      files.forEach(file => {
        // GPX
        if (file.name.toLowerCase().endsWith('.gpx')) {
          const r = new FileReader();
          r.onload = ev => {
            const xml = new DOMParser().parseFromString(ev.target.result, 'application/xml');
            const trkpts = xml.getElementsByTagName('trkpt');
            const pts = [];
            for (let i=0; i<trkpts.length; i++) {
              const lat = parseFloat(trkpts[i].getAttribute('lat'));
              const lon = parseFloat(trkpts[i].getAttribute('lon'));
              const ll = new kakao.maps.LatLng(lat, lon);
              pts.push(ll); bounds.extend(ll);
            }
            if (pts.length) {
              const poly = new kakao.maps.Polyline({
                map, path: pts,
                strokeWeight: 4, strokeColor: '#FF7F00',
                strokeOpacity: 0.9, strokeStyle: 'solid'
              });
              kakao.maps.event.addListener(poly, 'rightclick', () => {
                if (confirm('이 경로를 삭제하시겠습니까?')) poly.setMap(null);
              });
              polylines.push(poly);
            }
            const wpts = xml.getElementsByTagName('wpt');
            for (let i=0; i<wpts.length; i++) {
              const lat = parseFloat(wpts[i].getAttribute('lat'));
              const lon = parseFloat(wpts[i].getAttribute('lon'));
              const name = wpts[i].getElementsByTagName('name')[0]?.textContent || '';
              const ll = new kakao.maps.LatLng(lat, lon);
              bounds.extend(ll);
              addMarker(ll, name);
            }
            if (!bounds.isEmpty()) map.setBounds(bounds);
          };
          r.readAsText(file);
        }
        // 이미지
        else if (file.type.startsWith('image/')) {
          EXIF.getData(file, function() {
            const lat = EXIF.getTag(this,'GPSLatitude');
            const lon = EXIF.getTag(this,'GPSLongitude');
            const latRef = EXIF.getTag(this,'GPSLatitudeRef') || 'N';
            const lonRef = EXIF.getTag(this,'GPSLongitudeRef') || 'E';
            if (!lat||!lon) return alert('사진에 위치 정보가 없습니다.');
            const conv = (dms, ref) => {
              const [d,m,s] = dms;
              let dec = d + m/60 + s/3600;
              return (ref==='S'||ref==='W')?-dec:dec;
            };
            const latitude  = conv(lat, latRef);
            const longitude = conv(lon, lonRef);
            const ll = new kakao.maps.LatLng(latitude, longitude);
            bounds.extend(ll);
            const nameNoExt = file.name.replace(/\.[^/.]+$/, '');
            addPhotoMarker(ll, URL.createObjectURL(file), nameNoExt);
            if (!bounds.isEmpty()) map.setBounds(bounds);
          });
        }
      });
    });

    function addMarker(latlng, desc='설명 없음') {
      const marker = new kakao.maps.Marker({ map, position: latlng });
      const div = document.createElement('div');
      div.style = 'position:relative;padding:5px;font-size:13px';
      div.textContent = desc;
      const btn = document.createElement('div');
      btn.innerHTML = '✖';
      btn.style = 'position:absolute;top:2px;right:2px;cursor:pointer;font-weight:bold';
      div.appendChild(btn);
      const iw = new kakao.maps.InfoWindow({ content: div });
      kakao.maps.event.addListener(marker,'click', ()=>iw.open(map,marker));
      btn.onclick = ()=>iw.close();
      markers.push({marker,iw});
    }

    function addPhotoMarker(latlng, imgSrc, filename) {
      const marker = new kakao.maps.Marker({ map, position: latlng });
      const div = document.createElement('div');
      div.style = 'position:relative;padding:5px;';
      const title = document.createElement('div');
      title.textContent = filename;
      title.style = 'font-weight:bold;margin-bottom:5px;font-size:0.7em;';
      const btn = document.createElement('div');
      btn.innerHTML = '✖';
      btn.style = 'position:absolute;top:2px;right:2px;cursor:pointer;font-weight:bold;';
      const img = document.createElement('img');
      img.src = imgSrc;
      img.style = 'height:450px;width:auto;display:block;';
      div.append(title, btn, img);
      const iw = new kakao.maps.InfoWindow({ content: div });
      kakao.maps.event.addListener(marker,'click', ()=>iw.open(map,marker));
      btn.onclick = ()=>iw.close();
      markers.push({marker,iw});
    }

    function startDrawing(){
      if (drawingMode) { drawingMode = false; return; }
      drawingMode = true;
      currentPath = [];
      currentPolyline = new kakao.maps.Polyline({
        map, path: currentPath,
        strokeWeight:3, strokeColor:'#FF0000',
        strokeOpacity:0.8, strokeStyle:'solid'
      });
      kakao.maps.event.addListener(currentPolyline,'rightclick',()=>{
        if(confirm('이 경로를 삭제하시겠습니까?')) currentPolyline.setMap(null);
      });
      polylines.push(currentPolyline);
    }

    function resetPolylines(){
      polylines.forEach(p=>p.setMap(null));
      polylines=[]; drawingMode=false;
    }

    function exportGPX(){
      const fname = prompt('파일명','data');
      if (fname === null) return;  // 취소 시 내보내기 중단
      let gpx = '<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="KakaoMap">\n';
      polylines.forEach((pl,i)=>{
        const path = pl.getPath();
        if(path.length){
          gpx += `<trk><name>path${i+1}</name><trkseg>\n`
               + path.map(pt=>`<trkpt lat="${pt.getLat()}" lon="${pt.getLng()}"></trkpt>\n`).join('')
               + '</trkseg></trk>\n';
        }
      });
      markers.forEach((m,i)=>{
        const p = m.marker.getPosition();
        gpx += `<wpt lat="${p.getLat()}" lon="${p.getLng()}"><name></name></wpt>\n`;
      });
      gpx += '</gpx>';
      const blob = new Blob([gpx],{type:'application/gpx+xml'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = fname + '.gpx';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function copyCoordinates(){
      const coords = document.getElementById('latitude').value + ', ' + document.getElementById('longitude').value;
      navigator.clipboard.writeText(coords);
    }

    document.getElementById('search-form').addEventListener('submit', e=>{
      e.preventDefault();
      new kakao.maps.services.Geocoder().addressSearch(
        document.getElementById('address-input').value,
        (r,s)=> {
          if (s===kakao.maps.services.Status.OK) map.setCenter(new kakao.maps.LatLng(r[0].y, r[0].x));
          else alert('검색 실패');
        }
      );
    });

    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('myLocationBtn').addEventListener('click', ()=> {
        if (!navigator.geolocation) return alert('위치 정보를 지원하지 않습니다.');
        navigator.geolocation.getCurrentPosition(pos=>{
          const ll = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          map.setCenter(ll);
          document.getElementById('latitude').value = pos.coords.latitude;
          document.getElementById('longitude').value = pos.coords.longitude;
        }, err=>alert('위치 정보를 가져올 수 없습니다: ' + err.message));
      });
    });

    window.onload = ()=>{
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos=>initializeMap(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude)),
          ()=>initializeMap(new kakao.maps.LatLng(37.5665,126.9780))
        );
      } else {
        initializeMap(new kakao.maps.LatLng(37.5665,126.9780));
      }
    };

    document.addEventListener('keydown', e=>{
      if (e.ctrlKey && e.key.toLowerCase()==='c'){ e.preventDefault(); copyCoordinates(); }
      if (e.ctrlKey && e.key.toLowerCase()==='l'){ e.preventDefault(); startDrawing(); }
    });
  </script>
</body>
</html>
