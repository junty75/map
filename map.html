<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>GPX & 사진 지도 (업데이트 최종)</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94bf4516825c146467eb2318cd55b782&libraries=services"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    html, body { height:100%; margin:0; overflow:hidden; }
    #map { width:100%; height:100%; }
    #search-form, #address-display, .controls, #myLocationBtn {
      position:absolute; background:white; padding:5px; border-radius:5px; box-shadow:0 2px 6px rgba(0,0,0,0.3); z-index:1000;
    }
    #search-form { top:10px; left:10px; display:flex; gap:5px; }
    #address-display { top:10px; left:260px; background:rgba(0,0,0,0.6); color:white; font-size:12px; white-space:nowrap; overflow:hidden; }
    .controls { top:10px; right:10px; display:flex; gap:6px; }
    #myLocationBtn { bottom:20px; right:20px; border-radius:50%; }
  </style>
</head>
<body>
  <form id="search-form">
    <input id="address-input" type="text" placeholder="주소 검색" style="padding:5px; width:180px;">
    <button type="submit" style="padding:5px;">검색</button>
  </form>
  <div id="address-display">주소 없음</div>
  <div id="myLocationBtn" title="내 위치로 이동">📍</div>
  <div class="controls">
    <label>위도:</label><input id="latitude" readonly size="12">
    <label>경도:</label><input id="longitude" readonly size="12">
    <button type="button" onclick="copyCoordinates()">복사 (Ctrl+C)</button>
    <button type="button" onclick="startDrawing()">선 그리기 (Ctrl+L)</button>
    <button type="button" onclick="resetPolylines()">선 초기화</button>
    <button type="button" onclick="resetAll()">화면 초기화</button>
    <button type="button" onclick="exportGPX()">GPX 내보내기</button>
  </div>
  <div id="map"></div>

<script>
let map, geocoder, drawingMode = false;
let markers = [], polylines = [], markerInputOverlay = null;
let currentPolyline, currentPath = [];

const trimCityProvince = str => str?.split(' ').slice(1).join(' ') || '';

function initializeMap(center) {
  map = new kakao.maps.Map(document.getElementById('map'), { center, level: 4, mapTypeId: kakao.maps.MapTypeId.HYBRID });
  geocoder = new kakao.maps.services.Geocoder();

  kakao.maps.event.addListener(map, 'click', e => {
    document.getElementById('latitude').value = e.latLng.getLat();
    document.getElementById('longitude').value = e.latLng.getLng();
    geocoder.coord2Address(e.latLng.getLng(), e.latLng.getLat(), (res, status) => {
      const el = document.getElementById('address-display');
      if (status === kakao.maps.services.Status.OK) {
        const legal = res[0].address?.address_name;
        const road = res[0].road_address?.address_name;
        el.innerText = road ? trimCityProvince(road) : trimCityProvince(legal);
      } else el.innerText = '주소 없음';
    });
    if (drawingMode) {
      currentPath.push(e.latLng);
      currentPolyline.setPath(currentPath);
    }
  });

  kakao.maps.event.addListener(map, 'rightclick', e => {
    if (drawingMode) drawingMode = false;
    else showMarkerInput(e.latLng);
  });
}
function showMarkerInput(latlng) {
  if (markerInputOverlay) markerInputOverlay.setMap(null);

  const container = document.createElement('div');
  container.innerHTML = `<input type="text" placeholder="마커 이름" style="width:120px;padding:3px;">
                         <button style="margin-top:4px;">추가</button>
                         <button style="margin-top:4px;">취소</button>`;
  container.style = 'background:white;padding:6px;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:flex;flex-direction:column;gap:4px;';

  markerInputOverlay = new kakao.maps.CustomOverlay({ position: latlng, content: container, yAnchor: 1 });
  markerInputOverlay.setMap(map);

  const [input, addBtn, cancelBtn] = container.querySelectorAll('input, button');
  input.focus();
  input.addEventListener('mousedown', e => e.stopPropagation());
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addBtn.click();
    }
  });

  addBtn.onclick = () => { addMarker(latlng, input.value.trim() || '설명 없음'); markerInputOverlay.setMap(null); };
  cancelBtn.onclick = () => markerInputOverlay.setMap(null);
}

function showEditInput(markerObj, label) {
  if (markerInputOverlay) markerInputOverlay.setMap(null);

  const container = document.createElement('div');
  container.innerHTML = `<input type="text" value="${label.textContent}" style="width:120px;padding:3px;">
                         <button style="margin-top:4px;">수정</button>
                         <button style="margin-top:4px;">삭제</button>`;
  container.style = 'background:white;padding:6px;border-radius:4px;box-shadow:0 2px 6px rgba(0,0,0,0.3);display:flex;flex-direction:column;gap:4px;';

  markerInputOverlay = new kakao.maps.CustomOverlay({ position: markerObj.marker.getPosition(), content: container, yAnchor: 1 });
  markerInputOverlay.setMap(map);

  const [input, editBtn, deleteBtn] = container.querySelectorAll('input, button');
  input.focus();
  input.addEventListener('mousedown', e => e.stopPropagation());
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      editBtn.click();
    }
  });

  editBtn.onclick = () => { label.textContent = input.value.trim() || '설명 없음'; markerObj.name = label.textContent; markerInputOverlay.setMap(null); };
  deleteBtn.onclick = () => { markerObj.marker.setMap(null); markerObj.iw.close(); markerInputOverlay.setMap(null); };
}

function addMarker(latlng, desc) {
  const marker = new kakao.maps.Marker({ map, position: latlng });
  const div = document.createElement('div');
  div.style = 'position:relative; display:flex; align-items:center; justify-content:space-between; padding:5px;';
  div.innerHTML = `<span>${desc}</span><div style="cursor:pointer; font-weight:bold;">✖</div>`;
  const [label, btn] = div.querySelectorAll('span, div');
  const iw = new kakao.maps.InfoWindow({ content: div });

  kakao.maps.event.addListener(marker, 'click', () => iw.open(map, marker));
  kakao.maps.event.addListener(marker, 'rightclick', () => showEditInput({ marker, iw, name: desc }, label));
  btn.onclick = () => iw.close();

  markers.push({ marker, iw, name: desc });
}

function addPhotoMarker(latlng, imgSrc, filename) {
  const marker = new kakao.maps.Marker({ map, position: latlng });
  const div = document.createElement('div');
  div.style = 'position:relative; padding:5px;';
  div.innerHTML = `<div style="font-weight:bold; margin-bottom:5px;">${filename}</div>
                   <div style="position:absolute; top:2px; right:2px; cursor:pointer;">✖</div>
                   <img src="${imgSrc}" style="height:400px;width:auto;display:block;">`;
  const [title, btn] = div.querySelectorAll('div');

  const iw = new kakao.maps.InfoWindow({ content: div });
  kakao.maps.event.addListener(marker, 'click', () => iw.open(map, marker));
  kakao.maps.event.addListener(marker, 'rightclick', () => showEditInput({ marker, iw, name: filename }, title));
  btn.onclick = () => iw.close();

  markers.push({ marker, iw, name: filename });
}

const resetPolylines = () => { polylines.forEach(p => p.setMap(null)); polylines = []; drawingMode = false; };
const resetAll = () => { markers.forEach(m => m.marker.setMap(null)); markers = []; resetPolylines(); };
const copyCoordinates = () => navigator.clipboard.writeText(`${latitude.value}, ${longitude.value}`);

function startDrawing() {
  if (drawingMode) return drawingMode = false;
  drawingMode = true;
  currentPath = [];
  currentPolyline = new kakao.maps.Polyline({ map, path: currentPath, strokeWeight:3, strokeColor:'#FF0000', strokeOpacity:0.8 });
  polylines.push(currentPolyline);
}

function exportGPX() {
  const fname = prompt('파일명', 'data'); if (!fname) return;
  let gpx = '<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="KakaoMap">\n';
  polylines.forEach((pl,i)=>{ gpx += `<trk><name>path${i+1}</name><trkseg>\n` + pl.getPath().map(p=>`<trkpt lat="${p.getLat()}" lon="${p.getLng()}"></trkpt>\n`).join('') + '</trkseg></trk>\n'; });
  markers.forEach(m => {
    const p = m.marker.getPosition();
    gpx += `<wpt lat="${p.getLat()}" lon="${p.getLng()}"><name>${m.name || ''}</name></wpt>\n`;
  });
  gpx += '</gpx>';
  const blob = new Blob([gpx], { type: 'application/gpx+xml' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fname + '.gpx';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// 파일 드래그 복구
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  const files = Array.from(e.dataTransfer.files);
  if (!files.length) return;
  const bounds = new kakao.maps.LatLngBounds();
  files.forEach(file => {
    if (file.name.toLowerCase().endsWith('.gpx')) {
      const reader = new FileReader();
      reader.onload = ev => {
        const xml = new DOMParser().parseFromString(ev.target.result, 'application/xml');
        const pts = Array.from(xml.getElementsByTagName('trkpt')).map(pt => {
          const ll = new kakao.maps.LatLng(parseFloat(pt.getAttribute('lat')), parseFloat(pt.getAttribute('lon')));
          bounds.extend(ll);
          return ll;
        });
        if (pts.length) {
          const poly = new kakao.maps.Polyline({ map, path: pts, strokeWeight:4, strokeColor:'#FF7F00', strokeOpacity:0.9 });
          polylines.push(poly);
        }
        Array.from(xml.getElementsByTagName('wpt')).forEach(wpt => {
          const ll = new kakao.maps.LatLng(parseFloat(wpt.getAttribute('lat')), parseFloat(wpt.getAttribute('lon')));
          bounds.extend(ll);
          addMarker(ll, wpt.getElementsByTagName('name')[0]?.textContent || '설명 없음');
        });
        if (!bounds.isEmpty()) map.setBounds(bounds);
      };
      reader.readAsText(file);
    } else if (file.type.startsWith('image/')) {
      EXIF.getData(file, function() {
        const lat = EXIF.getTag(this, 'GPSLatitude');
        const lon = EXIF.getTag(this, 'GPSLongitude');
        if (!lat || !lon) return alert('사진에 GPS 정보 없음');
        const conv = (dms, ref) => (dms[0] + dms[1]/60 + dms[2]/3600) * (ref === 'S' || ref === 'W' ? -1 : 1);
        const ll = new kakao.maps.LatLng(conv(lat, EXIF.getTag(this, 'GPSLatitudeRef')), conv(lon, EXIF.getTag(this, 'GPSLongitudeRef')));
        bounds.extend(ll);
        const name = file.name.replace(/\.[^/.]+$/, '');
        addPhotoMarker(ll, URL.createObjectURL(file), name);
        if (!bounds.isEmpty()) map.setBounds(bounds);
      });
    }
  });
});

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('search-form').addEventListener('submit', e => {
    e.preventDefault();
    geocoder.addressSearch(document.getElementById('address-input').value, (res, status) => {
      if (status === kakao.maps.services.Status.OK) {
        map.setCenter(new kakao.maps.LatLng(res[0].y, res[0].x));
      } else {
        alert('검색 실패');
      }
    });
  });

  document.getElementById('myLocationBtn').onclick = () => {
    navigator.geolocation.getCurrentPosition(pos => {
      const ll = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      map.setCenter(ll);
      document.getElementById('latitude').value = pos.coords.latitude;
      document.getElementById('longitude').value = pos.coords.longitude;
    }, err => alert('위치 정보를 가져올 수 없습니다: ' + err.message));
  };
});

window.onload = () => {
  navigator.geolocation.getCurrentPosition(
    pos => initializeMap(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude)),
    () => initializeMap(new kakao.maps.LatLng(37.5665, 126.9780))
  );
};
</script>
</body>
</html>
