<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>GPX 마커 및 경로 지도</title>
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94bf4516825c146467eb2318cd55b782&libraries=services">
// 키보드 단축키 리스너
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key.toLowerCase() === 'c') {
    e.preventDefault(); copyCoordinates();
  }
  if (e.ctrlKey && e.key.toLowerCase() === 'l') {
    e.preventDefault(); startDrawing();
  }
});

</script>
<style>
  html, body { height:100%; margin:0; padding:0; overflow:hidden; }
  #map { width:100%; height:100%; position:absolute; top:0; left:0; }
  #search-form { position:absolute; top:10px; left:10px; z-index:1000; background:white; padding:5px; border-radius:5px; box-shadow:0 2px 6px rgba(0,0,0,0.3); display:flex; gap:5px; }
  .controls { position:absolute; top:10px; right:10px; z-index:1000; background:white; padding:5px; border-radius:5px; box-shadow:0 2px 6px rgba(0,0,0,0.3); display:flex; gap:6px; align-items:center; }
  #myLocationBtn { position:absolute; bottom:20px; right:20px; z-index:10000; background:white; padding:8px; border-radius:50%; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.3); }
</style>
</head>
<body>
<form id="search-form">
  <input id="address-input" type="text" placeholder="주소 검색" style="padding:5px; width:180px;"/>
  <button type="submit" style="padding:5px;">검색</button>
    <div id=\"address-display\" style=\"margin-left:10px; font-weight:bold;\"></div>
    <span id=\"address-display\" style=\"margin-left:10px;font-weight:bold;\"></span>
</form>
<div id="myLocationBtn" title="내 위치로 이동">📍</div>
<div class="controls">
  <label>위도:</label><input id="latitude" readonly size="12"/>
  <label>경도:</label><input id="longitude" readonly size="12"/>
  <button onclick="copyCoordinates()">복사 (Ctrl+C)</button>
  <button onclick="startDrawing()">선 그리기 (Ctrl+L)</button>
  <button onclick="resetPolylines()">선 초기화</button>
  <button onclick="exportGPX()">GPX 내보내기</button>
</div>
<div id="map"></div>
<script>
let map, drawingMode=false, isFirstDraw=true;
let geocoder;let markers=[], polylines=[];
let selectedLatLng=null, currentPolyline=null, currentPath=[];

// 맵 초기화 (항공영상)
function initializeMap(center){
  map = new kakao.maps.Map(document.getElementById('map'), {
    center: center,
    level: 4,
    mapTypeId: kakao.maps.MapTypeId.SKYVIEW
  });
  geocoder = new kakao.maps.services.Geocoder();  geocoder = new kakao.maps.services.Geocoder();
  map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
  map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);

  kakao.maps.event.addListener(map, 'click', e => {
    selectedLatLng = e.latLng;
    document.getElementById('latitude').value = selectedLatLng.getLat();
    document.getElementById('longitude').value = selectedLatLng.getLng();
    geocoder.coord2Address(
      selectedLatLng.getLng(), selectedLatLng.getLat(),
      function(result, status) {
        let road = '', jibun = '';
        if (status === kakao.maps.services.Status.OK) {
          road = result[0].road_address ? result[0].road_address.address_name : '';
          jibun = result[0].address ? result[0].address.address_name : '';
        }
        const addrText = road && jibun ? road + ' (' + jibun + ')' : (road || jibun || '주소 없음');
        document.getElementById('address-display').textContent = addrText;
      }
    );
    if(drawingMode){
      currentPath.push(selectedLatLng);
      currentPolyline.setPath(currentPath);
    }
  });

  kakao.maps.event.addListener(map, 'rightclick', e => {
    if(drawingMode){
      drawingMode=false;
      
    } else {
      addMarker(e.latLng);
    }
  });
}

// 내 위치 이동
function moveToMyLocation(){
  if(!navigator.geolocation){
    return alert('브라우저가 위치 정보를 지원하지 않습니다.');
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      const ll = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      map.setCenter(ll);
      document.getElementById('latitude').value = pos.coords.latitude;
      document.getElementById('longitude').value = pos.coords.longitude;
    },
    err => alert('위치 정보를 가져올 수 없습니다: ' + err.message)
  );
}

// 마커 생성
function addMarker(latlng, presetDesc){
  if(!latlng) return alert('좌표를 먼저 클릭해주세요');
  let desc = (typeof presetDesc === 'string') ? presetDesc : prompt('마커 설명을 입력하세요', '설명 없음');
  if(desc === null) return;
  if(desc.trim() === '') desc = '설명 없음';
  const marker = new kakao.maps.Marker({ map, position: latlng });
  const info = document.createElement('div');
  info.style = 'position:relative;padding:5px 25px 5px 5px;font-size:13px';
  info.innerHTML = desc;
  const closeBtn = document.createElement('div');
  closeBtn.innerHTML = '✖'; closeBtn.style = 'position:absolute;top:5px;right:0;cursor:pointer;font-weight:bold';
  info.appendChild(closeBtn);
  const iw = new kakao.maps.InfoWindow({ content: info });
  kakao.maps.event.addListener(marker, 'click', () => iw.open(map, marker));
  closeBtn.onclick = () => iw.close();
  kakao.maps.event.addListener(marker, 'rightclick', () => {
    if(confirm('이 마커를 삭제하시겠습니까?')){
      marker.setMap(null);
      markers = markers.filter(m => m.marker !== marker);
    }
  });
  markers.push({ marker, infowindow: iw, desc });
}

// 폴리라인 그리기
function startDrawing(){
  if(drawingMode){
    drawingMode=false; 
    return;
  }
  drawingMode=true; currentPath=[];
  currentPolyline = new kakao.maps.Polyline({
    map, path: currentPath,
    strokeWeight: 3, strokeColor: '#FF0000', strokeOpacity: 0.8, strokeStyle: 'solid'
  });
  kakao.maps.event.addListener(currentPolyline, 'rightclick', () => {
    if(confirm('이 경로를 삭제하시겠습니까?')){
      currentPolyline.setMap(null);
      polylines = polylines.filter(p => p !== currentPolyline);
    }
  });
  kakao.maps.event.addListener(currentPolyline, 'mouseover', () => map.getContainer().style.cursor = 'pointer');
  kakao.maps.event.addListener(currentPolyline, 'mouseout', () => map.getContainer().style.cursor = 'default');
  polylines.push(currentPolyline);
  
}

// GPX 파일 드롭 로드
document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if(!file || !file.name.endsWith('.gpx')) return alert('GPX 파일만 가능합니다');
  const reader = new FileReader();
  reader.onload = ev => {
    const xml = new DOMParser().parseFromString(ev.target.result, 'application/xml');
    const bounds = new kakao.maps.LatLngBounds();
    const trkpts = xml.getElementsByTagName('trkpt');
    if(trkpts.length){
      let arr = [];
      for(let i=0; i<trkpts.length; i++){
        const lat = parseFloat(trkpts[i].getAttribute('lat'));
        const lon = parseFloat(trkpts[i].getAttribute('lon'));
        const ll = new kakao.maps.LatLng(lat, lon);
        arr.push(ll); bounds.extend(ll);
      }
      const poly = new kakao.maps.Polyline({
        map, path: arr,
        strokeWeight:4,
        strokeColor: '#FF7F00',
        strokeOpacity:0.9,
        strokeStyle:'solid'
      });
      kakao.maps.event.addListener(poly, 'rightclick', () => {
        if(confirm('이 경로를 삭제하시겠습니까?')){
          poly.setMap(null);
          polylines = polylines.filter(p => p !== poly);
        }
      });
      kakao.maps.event.addListener(poly, 'mouseover', () => map.getContainer().style.cursor='pointer');
      kakao.maps.event.addListener(poly, 'mouseout', () => map.getContainer().style.cursor='default');
      polylines.push(poly);
    }
    const wpts = xml.getElementsByTagName('wpt');
    for(let i=0; i<wpts.length; i++){
      const lat = parseFloat(wpts[i].getAttribute('lat'));
      const lon = parseFloat(wpts[i].getAttribute('lon'));
      const name = wpts[i].getElementsByTagName('name')[0]?.textContent || '설명 없음';
      const ll = new kakao.maps.LatLng(lat, lon);
      bounds.extend(ll);
      addMarker(ll, name);
    }
    if(!bounds.isEmpty()) map.setBounds(bounds);
  };
  reader.readAsText(file);
});

// 기타 기능
function resetPolylines(){ polylines.forEach(p=>p.setMap(null)); polylines=[]; drawingMode=false; }
function exportGPX(){
  const fname = prompt('파일명','data')||'data';
  let gpx = '<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="KakaoMap">\n';
  polylines.forEach((pl,i)=>{ const path=pl.getPath(); if(path.length){
    gpx+=`<trk><name>path${i+1}</name><trkseg>\n`+path.map(pt=>`<trkpt lat="${pt.getLat()}" lon="${pt.getLng()}"></trkpt>\n`).join('')+'</trkseg></trk>\n'; }
  });
  markers.forEach((m,i)=>{ const p=m.marker.getPosition(); gpx+=`<wpt lat="${p.getLat()}" lon="${p.getLng()}"><name>${m.desc}</name></wpt>\n`; });
  gpx+='</gpx>'; const blob=new Blob([gpx],{type:'application/gpx+xml'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname+'.gpx'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}
function copyCoordinates() {
  const coords = document.getElementById('latitude').value + ', ' + document.getElementById('longitude').value;
  navigator.clipboard.writeText(coords);
}
function moveToMyLocation(){ if(navigator.geolocation) navigator.geolocation.getCurrentPosition(pos=>initializeMap(new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude)), err=>alert('위치 정보 오류: '+err.message)); else alert('브라우저 지원 불가'); }
document.getElementById('search-form').addEventListener('submit', e=>{ e.preventDefault(); new kakao.maps.services.Geocoder().addressSearch(document.getElementById('address-input').value,(r,s)=> s===kakao.maps.services.Status.OK?map.setCenter(new kakao.maps.LatLng(r[0].y,r[0].x)):alert('검색 실패')); });
document.addEventListener('DOMContentLoaded', ()=>{ document.getElementById('myLocationBtn').addEventListener('click', moveToMyLocation); });
window.onload = () => { if(navigator.geolocation) navigator.geolocation.getCurrentPosition(pos=>initializeMap(new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude)), ()=>initializeMap(new kakao.maps.LatLng(37.5665,126.9780))); else initializeMap(new kakao.maps.LatLng(37.5665,126.9780)); };

// 키보드 단축키 리스너
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key.toLowerCase() === 'c') {
    e.preventDefault(); copyCoordinates();
  }
  if (e.ctrlKey && e.key.toLowerCase() === 'l') {
    e.preventDefault(); startDrawing();
  }
});

</script>
</body>
</html>
