<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>GPX & 사진 지도 (v3.1)</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=94bf4516825c146467eb2318cd55b782&libraries=services"></script>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    html, body { height:100%; margin:0; overflow:hidden; }
    #map { width:100%; height:100%; }
    #search-form, #address-display, .controls, #myLocationBtn {
      position:absolute; background:white; padding:5px; border-radius:5px; box-shadow:0 2px 6px rgba(0,0,0,0.3); z-index:1000;
    }
    #search-form { top:10px; left:10px; display:flex; gap:5px; }
    #address-display { top:10px; left:260px; background:rgba(0,0,0,0.6); color:white; font-size:12px; white-space:nowrap; overflow:hidden; }
    .controls { top:10px; right:10px; display:flex; gap:6px; }
    #myLocationBtn { bottom:20px; right:20px; border-radius:50%; }
  </style>
</head>
<body>

  <form id="search-form">
    <input id="address-input" type="text" placeholder="주소 검색" style="padding:5px; width:180px;">
    <button type="submit" style="padding:5px;">검색</button>
  </form>
  <div id="address-display">주소 없음</div>
  <div id="myLocationBtn" title="내 위치로 이동">📍</div>
  <div class="controls">
    <label>위도:</label><input id="latitude" readonly size="12">
    <label>경도:</label><input id="longitude" readonly size="12">
    <button type="button" onclick="copyCoordinates()">복사 (Ctrl+C)</button>
    <button type="button" onclick="startDrawing()">선 그리기 (Alt)</button>
    <button type="button" onclick="resetPolylines()">선 초기화</button>
    <button type="button" onclick="resetAll()">화면 초기화</button>
    <button type="button" onclick="exportGPX()">GPX 내보내기</button>
  </div>
  <div id="map"></div>

<script>
let map, geocoder, drawingMode = false;
let markers = [], polylines = [], searchMarkers = [], markerInputOverlay = null;
let currentPolyline = null;

const trimCityProvince = str => str?.split(' ').slice(1).join(' ') || '';

function initializeMap(center) {
  map = new kakao.maps.Map(document.getElementById('map'), { center, level: 4, mapTypeId: kakao.maps.MapTypeId.HYBRID });
  geocoder = new kakao.maps.services.Geocoder();

  kakao.maps.event.addListener(map, 'click', onMapClick);
  kakao.maps.event.addListener(map, 'rightclick', e => drawingMode ? drawingMode = false : showMarkerInput(e.latLng));
  document.getElementById('search-form').addEventListener('submit', onSearchSubmit);
  document.getElementById('myLocationBtn').onclick = moveToMyLocation;

  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key.toLowerCase() === 'c') copyCoordinates();
    if (e.altKey) startDrawing();
  });
}

function onMapClick(e) {
  if (markerInputOverlay) return markerInputOverlay.setMap(null), markerInputOverlay = null;

  if (drawingMode && currentPolyline) {
    const path = currentPolyline.getPath();
    path.push(e.latLng);
    currentPolyline.setPath(path);
    console.log('폴리라인 업데이트:', path.getArray());
  } else {
    markers.forEach(m => m.iw.close());
    document.getElementById('latitude').value = e.latLng.getLat();
    document.getElementById('longitude').value = e.latLng.getLng();
    updateAddressDisplay(e.latLng);
  }
}

function onSearchSubmit(e) {
  e.preventDefault();
  const query = document.getElementById('address-input').value.trim();
  if (!query) return;

  geocoder.addressSearch(query, (res, status) => {
    if (status === kakao.maps.services.Status.OK) {
      const latlng = new kakao.maps.LatLng(res[0].y, res[0].x);
      map.setCenter(latlng);
      clearSearchMarkers();
      addSearchMarker(latlng, query);
    } else {
      alert('주소를 찾을 수 없습니다');
    }
  });
}

function moveToMyLocation() {
  navigator.geolocation.getCurrentPosition(
    pos => {
      const ll = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
      map.setCenter(ll);
      document.getElementById('latitude').value = pos.coords.latitude;
      document.getElementById('longitude').value = pos.coords.longitude;
    },
    err => alert('위치 정보를 가져올 수 없습니다: ' + err.message)
  );
}

function startDrawing() {
  if (drawingMode) return drawingMode = false;
  drawingMode = true;
  currentPolyline = new kakao.maps.Polyline({ map, path: [], strokeWeight: 3, strokeColor: '#FF0000', strokeOpacity: 0.8 });
  polylines.push(currentPolyline);
}

function updateAddressDisplay(latlng) {
  geocoder.coord2Address(latlng.getLng(), latlng.getLat(), (res, status) => {
    const el = document.getElementById('address-display');
    if (status === kakao.maps.services.Status.OK) {
      const legal = res[0].address?.address_name || '주소 없음';
      const road = res[0].road_address?.address_name;
      el.innerText = road ? `${legal} / ${trimCityProvince(road)}` : legal;
    } else {
      el.innerText = '주소 없음';
    }
  });
}

function copyCoordinates() {
  const lat = document.getElementById('latitude').value;
  const lng = document.getElementById('longitude').value;
  navigator.clipboard.writeText(`${lat}, ${lng}`);
}

function clearSearchMarkers() {
  searchMarkers.forEach(m => m.setMap(null));
  searchMarkers = [];
}

function addSearchMarker(latlng, text) {
  const marker = new kakao.maps.Marker({ map, position: latlng });
  const iw = new kakao.maps.InfoWindow({ content: `<div style="padding:5px;font-size:14px;">${text}</div>` });
  kakao.maps.event.addListener(marker, 'click', () => iw.open(map, marker));
  searchMarkers.push(marker);
}

const resetPolylines = () => { polylines.forEach(p => p.setMap(null)); polylines = []; drawingMode = false; };
const resetAll = () => { markers.forEach(m => m.marker.setMap(null)); markers = []; resetPolylines(); clearSearchMarkers(); };

function exportGPX() {
  const fname = prompt('파일명', 'data'); if (!fname) return;
  let gpx = '<?xml version="1.0" encoding="UTF-8"?><gpx version="1.1" creator="KakaoMap">\n';
  polylines.forEach((pl,i)=>{ gpx += `<trk><name>path${i+1}</name><trkseg>\n` + pl.getPath().map(p=>`<trkpt lat="${p.getLat()}" lon="${p.getLng()}"></trkpt>\n`).join('') + '</trkseg></trk>\n'; });
  markers.forEach(m => {
    const p = m.marker.getPosition();
    gpx += `<wpt lat="${p.getLat()}" lon="${p.getLng()}"><name>${m.name || ''}</name></wpt>\n`;
  });
  gpx += '</gpx>';
  const blob = new Blob([gpx], { type: 'application/gpx+xml' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fname + '.gpx';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// 초기화
window.onload = () => {
  navigator.geolocation.getCurrentPosition(
    pos => initializeMap(new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude)),
    () => initializeMap(new kakao.maps.LatLng(37.5665, 126.9780))
  );
};
</script>
</body>
</html>
